import"./modulepreload-polyfill.b7f2da20.js";import{c as M,s as O,f as fe,m as we,t as I,a as xe,r as W,b as S,d as g,e as pe,g as N,n as be,h as Fe,$ as Ie,i as Te,j as Ue,w as A,p as G,o as Me}from"./vendor.02ae8e2c.js";var Re=`attribute vec4 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat4 uModelViewMatrix;
uniform mat4 uProjectionMatrix;

varying highp vec2 vTextureCoord;

void main(void) {
  gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;
  vTextureCoord = aTextureCoord;
}`,ve=`varying highp vec2 vTextureCoord;
uniform sampler2D uTexture;

uniform bool uHighlight;

void main(void) {

  if (uHighlight) {
    gl_FragColor = texture2D(uTexture, vTextureCoord) + vec4(0.1, 0.1, 0.1, 0.0);
  } else {
    gl_FragColor = texture2D(uTexture, vTextureCoord);
  }
  
}`;function Be(e,a){return new Promise((o,c)=>{const r=e.createTexture();e.bindTexture(e.TEXTURE_2D,r);const t=new Image;t.onload=()=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),z(t.width)&&z(t.height)?e.generateMipmap(e.TEXTURE_2D):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),o(r)},t.src=a})}function z(e){return(e&e-1)==0}function h(e,a){return new Promise(async(o,c)=>{const t=await(await fetch(a)).json(),d=t.scenes[t.scene],s=await(await fetch(t.buffers[0].uri)).blob();let u=[...d.nodes],m=0,f=[],T=[],R=[];for(;m<u.length;){let ie=T.length/3;const w=t.nodes[u[m]];if(w.children&&u.push(...w.children),w.mesh!==void 0){let U=M();if(w.scale&&O(U,U,w.scale),w.rotation){const x=M();fe(x,w.rotation),we(U,U,x)}w.translation&&I(U,U,w.translation);const V=t.meshes[w.mesh].primitives[0],ae=V.indices,oe=t.accessors[ae],X=t.bufferViews[oe.bufferView],re=s.slice(X.byteOffset,X.byteOffset+X.byteLength),ne=new Int16Array(await re.arrayBuffer());f.push(...ne.map(x=>x+ie));const se=V.attributes.POSITION,ce=t.accessors[se],Q=t.bufferViews[ce.bufferView],de=s.slice(Q.byteOffset,Q.byteOffset+Q.byteLength),E=new Float32Array(await de.arrayBuffer());for(let x=0;x<E.length;x+=3){let j=[E[x],E[x+1],E[x+2]];xe(j,j,U),T.push(...j)}const le=V.attributes.TEXCOORD_0,he=t.accessors[le],Z=t.bufferViews[he.bufferView],ue=s.slice(Z.byteOffset,Z.byteOffset+Z.byteLength),me=new Float32Array(await ue.arrayBuffer());R.push(...me)}m++}const te=await Be(e,t.images[0].uri),J=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,J),e.bufferData(e.ARRAY_BUFFER,new Float32Array(T),e.STATIC_DRAW);const Y=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,Y),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(f),e.STATIC_DRAW);const D=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,D),e.bufferData(e.ARRAY_BUFFER,new Float32Array(R),e.STATIC_DRAW),o({buffers:{index:Y,vertex:J,texCoords:D},indexCount:f.length,texture:te})})}var ye="data:model/gltf+json;base64,eyJhc3NldCI6eyJ2ZXJzaW9uIjoiMi4wIiwiZ2VuZXJhdG9yIjoiQmxvY2tiZW5jaCA0LjEuMSBnbFRGIGV4cG9ydGVyIn0sInNjZW5lcyI6W3sibm9kZXMiOlsxXSwibmFtZSI6ImJsb2NrYmVuY2hfZXhwb3J0In1dLCJzY2VuZSI6MCwibm9kZXMiOlt7Im5hbWUiOiJwbGFuZSIsIm1lc2giOjB9LHsiY2hpbGRyZW4iOlswXX1dLCJidWZmZXJWaWV3cyI6W3siYnVmZmVyIjowLCJieXRlT2Zmc2V0IjowLCJieXRlTGVuZ3RoIjo0OCwidGFyZ2V0IjozNDk2MiwiYnl0ZVN0cmlkZSI6MTJ9LHsiYnVmZmVyIjowLCJieXRlT2Zmc2V0Ijo0OCwiYnl0ZUxlbmd0aCI6NDgsInRhcmdldCI6MzQ5NjIsImJ5dGVTdHJpZGUiOjEyfSx7ImJ1ZmZlciI6MCwiYnl0ZU9mZnNldCI6OTYsImJ5dGVMZW5ndGgiOjMyLCJ0YXJnZXQiOjM0OTYyLCJieXRlU3RyaWRlIjo4fSx7ImJ1ZmZlciI6MCwiYnl0ZU9mZnNldCI6MTI4LCJieXRlTGVuZ3RoIjoxMiwidGFyZ2V0IjozNDk2M31dLCJidWZmZXJzIjpbeyJieXRlTGVuZ3RoIjoxNDAsInVyaSI6ImRhdGE6YXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtO2Jhc2U2NCxBQUFBUUFBQUFBQUFBQUFBQUFBQVFBQUFBQUFBQUFEQUFBQUFBQUFBQUFBQUFBREFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFnRDhBQUFBQUFBQUFBQUFBZ0Q4QUFBQUFBQUFBQUFBQWdEOEFBQUFBQUFBQUFBQUFnRDhBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUNBUHdBQWdEOEFBSUEvQUFDQVB3QUFBQUFBQUFFQUFnQUFBQUlBQXdBPSJ9XSwiYWNjZXNzb3JzIjpbeyJidWZmZXJWaWV3IjowLCJjb21wb25lbnRUeXBlIjo1MTI2LCJjb3VudCI6NCwibWF4IjpbMiwwLDBdLCJtaW4iOlswLDAsLTJdLCJ0eXBlIjoiVkVDMyJ9LHsiYnVmZmVyVmlldyI6MSwiY29tcG9uZW50VHlwZSI6NTEyNiwiY291bnQiOjQsIm1heCI6WzAsMSwwXSwibWluIjpbMCwxLDBdLCJ0eXBlIjoiVkVDMyJ9LHsiYnVmZmVyVmlldyI6MiwiY29tcG9uZW50VHlwZSI6NTEyNiwiY291bnQiOjQsIm1heCI6WzEsMV0sIm1pbiI6WzAsMF0sInR5cGUiOiJWRUMyIn0seyJidWZmZXJWaWV3IjozLCJjb21wb25lbnRUeXBlIjo1MTIzLCJjb3VudCI6NiwibWF4IjpbM10sIm1pbiI6WzBdLCJ0eXBlIjoiU0NBTEFSIn1dLCJtYXRlcmlhbHMiOlt7InBick1ldGFsbGljUm91Z2huZXNzIjp7Im1ldGFsbGljRmFjdG9yIjowLCJyb3VnaG5lc3NGYWN0b3IiOjEsImJhc2VDb2xvclRleHR1cmUiOnsiaW5kZXgiOjB9fSwiYWxwaGFNb2RlIjoiTUFTSyIsImFscGhhQ3V0b2ZmIjowLjA1LCJkb3VibGVTaWRlZCI6dHJ1ZX1dLCJ0ZXh0dXJlcyI6W3sic2FtcGxlciI6MCwic291cmNlIjowLCJuYW1lIjoiZ3Jhc3MifV0sInNhbXBsZXJzIjpbeyJtYWdGaWx0ZXIiOjk3MjgsIm1pbkZpbHRlciI6OTcyOCwid3JhcFMiOjMzMDcxLCJ3cmFwVCI6MzMwNzF9XSwiaW1hZ2VzIjpbeyJtaW1lVHlwZSI6ImltYWdlL3BuZyIsInVyaSI6ImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQ0FBQUFBZ0NBWUFBQUJ6ZW5yMEFBQUFNa2xFUVZSWVIrM1FRUkVBQUFRQVFib2EwZFFraHM5ZWdwdk5tdDU0TEEwUUlFQ0FBQUVDQkFnUUlFQ0FBQUVDM3dJSDRVbE9BVit2UnpVQUFBQUFTVVZPUks1Q1lJST0ifV0sIm1lc2hlcyI6W3sicHJpbWl0aXZlcyI6W3sibW9kZSI6NCwiYXR0cmlidXRlcyI6eyJQT1NJVElPTiI6MCwiTk9STUFMIjoxLCJURVhDT09SRF8wIjoyfSwiaW5kaWNlcyI6MywibWF0ZXJpYWwiOjB9XX1dfQ==",Ee="/taptown/assets/Road-x.25087994.gltf",Ce="/taptown/assets/Road-right.05535041.gltf",_e="/taptown/assets/Road-left.e4d57c46.gltf",Le="/taptown/assets/Road-y.43b84893.gltf",Ve="/taptown/assets/Road-up.f33fbfbe.gltf",Xe="/taptown/assets/Road-down.3aa34828.gltf",Qe="/taptown/assets/Road-cross.c0149426.gltf",Ze="/taptown/assets/Road-upleft.8e8e8992.gltf",je="/taptown/assets/Road-leftdown.43e4587d.gltf",We="/taptown/assets/Road-downright.2ee19715.gltf",Se="/taptown/assets/Road-rightup.f9b3a2d6.gltf",Ae="/taptown/assets/Road-T.dd27be2f.gltf",Pe="/taptown/assets/Road-l-.8fa437e2.gltf",Je="/taptown/assets/Road--l.cec3388c.gltf",Ye="/taptown/assets/Road-_l_.04dac8e2.gltf",De="/taptown/assets/Road-single.f2299542.gltf",Oe="/taptown/assets/outofbounds.8b7ad541.gltf",ge="/taptown/assets/Cafe.5a05628e.gltf";const l=[null];let H=!1;async function Ne(e){l[0]=await h(e,ye),l[1]=await h(e,Ee),l[2]=await h(e,Ce),l[3]=await h(e,_e),l[4]=await h(e,Le),l[5]=await h(e,Ve),l[6]=await h(e,Xe),l[7]=await h(e,Qe),l[8]=await h(e,Ze),l[9]=await h(e,je),l[10]=await h(e,We),l[11]=await h(e,Se),l[12]=await h(e,Ae),l[13]=await h(e,Pe),l[14]=await h(e,Je),l[15]=await h(e,Ye),l[16]=await h(e,De),l[254]=await h(e,Oe),l[255]=await h(e,ge),H=!0}function k(e,a,[o,c],r,t,d){if(!H)throw"Models aren't loaded!";const n=l[a];if(!n)return;const s=M();I(s,d,[o*2,0,c*2]);{const u=3,m=e.FLOAT,f=!1,T=0,R=0;e.bindBuffer(e.ARRAY_BUFFER,n.buffers.vertex),e.vertexAttribPointer(r.attribLocations.vertexPosition,u,m,f,T,R),e.enableVertexAttribArray(r.attribLocations.vertexPosition)}{const u=2,m=e.FLOAT,f=!1,T=0,R=0;e.bindBuffer(e.ARRAY_BUFFER,n.buffers.texCoords),e.vertexAttribPointer(r.attribLocations.textureCoordPosition,u,m,f,T,R),e.enableVertexAttribArray(r.attribLocations.textureCoordPosition)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.buffers.index),e.useProgram(r.program),e.uniformMatrix4fv(r.uniformLocations.projectionMatrix,!1,t),e.uniformMatrix4fv(r.uniformLocations.modelViewMatrix,!1,s),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,n.texture),e.uniform1i(r.uniformLocations.texture,0),e.drawElements(e.TRIANGLES,n.indexCount,e.UNSIGNED_SHORT,0)}class Ge{constructor(){this.x=0,this.z=0,this._pointerDown=!1,this._velocityX=0,this._velocityY=0,this._inFocusMode=!1,this.cameraMatrix=M(),I(this.cameraMatrix,this.cameraMatrix,[0,0,-3]),W(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),S(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),document.addEventListener("pointerdown",a=>{this._pointerDown=!0,this._prevPointerX=a.clientX,this._prevPointerY=a.clientY}),document.addEventListener("pointerup",()=>this._pointerDown=!1),document.addEventListener("pointermove",a=>{this._pointerDown&&(this._moveCamera(a.clientX-this._prevPointerX,a.clientY-this._prevPointerY),this._velocityX=a.clientX-this._prevPointerX,this._velocityY=a.clientY-this._prevPointerY),this._prevPointerX=a.clientX,this._prevPointerY=a.clientY})}_moveCamera(a,o){if(this._inFocusMode)return;const c=a/this._pixelToTileX,r=o/this._pixelToTileZ*1.425,t=[c,r];g(t,t,[0,0],45*Math.PI/180),this.x-=t[0],this.z-=t[1],I(this.cameraMatrix,this.cameraMatrix,[t[0],0,t[1]])}setPixelToTileRatio(a,o){this._pixelToTileX=a,this._pixelToTileZ=o}update(a){let o=a/16.66667;this._pointerDown||(this._velocityX=Math.floor(Math.abs(this._velocityX)/10.25*o)*Math.sign(this._velocityX)*10*o,this._velocityY=Math.floor(Math.abs(this._velocityY)/10.25*o)*Math.sign(this._velocityY)*10*o,this._moveCamera(this._velocityX,this._velocityY))}enterFocus([a,o]){this._inFocusMode=!0;const c=Date.now(),r=()=>{let t=(Date.now()-c)/1e3;t>1&&(t=1);const d=-this.x*(1-t)+(-a*2+innerWidth/200)*t,n=-this.z*(1-t)+(-o*2+innerHeight/200)*t,s=1;this.cameraMatrix=M(),I(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),W(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),S(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),O(this.cameraMatrix,this.cameraMatrix,[s,s,s]),I(this.cameraMatrix,this.cameraMatrix,[d,0,n]),t<1&&requestAnimationFrame(r)};requestAnimationFrame(r)}exitFocus(){this.cameraMatrix=M(),I(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),W(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),S(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),I(this.cameraMatrix,this.cameraMatrix,[-this.x,0,-this.z]),this._inFocusMode=!1}}var $=`.close-button {
  position: absolute;
  top: 1rem;
  right: 1rem;
  width: 2rem;
  height: 2rem;
  image-rendering: crisp-edges;
  image-rendering: pixelated;
}

.cover-canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 2;
}

.tile-menu {
  position: absolute;
  background: #555;
  z-index: 2;
}
@media (orientation: portrait) {
  .tile-menu {
    left: 0;
    bottom: 0;
    width: 100%;
    height: 50%;
  }
}`,P=globalThis&&globalThis.__decorate||function(e,a,o,c){var r=arguments.length,t=r<3?a:c===null?c=Object.getOwnPropertyDescriptor(a,o):c,d;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")t=Reflect.decorate(e,a,o,c);else for(var n=e.length-1;n>=0;n--)(d=e[n])&&(t=(r<3?d(t):r>3?d(a,o,t):d(a,o))||t);return r>3&&t&&Object.defineProperty(a,o,t),t};console.log($);let B=class extends Fe{render(){return Ie`
      <!-- cover canvas prevents further interaction with the canvas until the menu is closed -->
      <div class="cover-canvas"></div>
      <div class="tile-menu">
        <img src="../icons/close.png" alt="close" class="close-button" />
        <h1>${this.x}, ${this.z}</h1>
      </div>
    `}};B.styles=pe([$]);P([N()],B.prototype,"x",void 0);P([N()],B.prototype,"z",void 0);B=P([be("tt-tile")],B);const ze=document.querySelector(".money"),He=document.querySelector(".population");function ke(e){ze.textContent=`$${e.money}`,He.textContent=`${e.population}`}function $e(e,a){const o=document.createElement("tt-tile");o.x=e,o.z=a,document.body.appendChild(o)}function qe(){return new Worker("/taptown/assets/ambient.6d469442.js",{type:"module"})}function Ke(){return new Worker("/taptown/assets/buildings.e31b2e78.js",{type:"module"})}function et(){return new Worker("/taptown/assets/people.f51a4310.js",{type:"module"})}let C,q;const p=document.getElementsByTagName("canvas")[0];let v=2*(innerWidth/200),_=2*(innerHeight/200),L,y,b=new Ge,F=[-100,-100];window.camera=b;p.width=innerWidth*devicePixelRatio;p.height=innerHeight*devicePixelRatio;let K=innerWidth/v,ee=innerHeight/_;b.setPixelToTileRatio(K,ee);let i=p.getContext("webgl");window.addEventListener("resize",()=>{p.width=innerWidth*devicePixelRatio,p.height=innerHeight*devicePixelRatio,i.viewport(0,0,p.width,p.height),v=2*(innerWidth/200),_=2*(innerHeight/200);let e=innerWidth/v,a=innerHeight/_;b.setPixelToTileRatio(e,a)});p.addEventListener("mousemove",e=>{const a=e.clientX/K/2,o=e.clientY/ee/2*1.425,c=[a,o];g(c,c,[0,0],45*Math.PI/180);const r=[b.x/2+3.62,b.z/2-2.62];Te(c,c,r),Ue(c,c),F=c});p.addEventListener("click",e=>{const a=F[1]*y+F[0];C.setTile(F[0],F[1],L[a]+1),$e(F[0],F[1])});tt();async function tt(){const e=A(new qe);e.log();const a=A(new Ke);a.log();const o=A(new et);o.log(),await new e,C=await new a,await C.setCallback(G(f=>{L=f,y=Math.sqrt(L.length)})),q=await new o,await q.setCallback(G(f=>{ke(f)}));const r=new URLSearchParams(location.search).get("save");r||(alert("Save not provided."),location.replace("../"));const t=await C.loadSave(r);t||(alert("Save couldn't be loaded."),location.replace("../")),document.title=`\u{1F3E0} ${r} \u2022 TapTown!`,console.log(t);const d=i.createShader(i.VERTEX_SHADER);i.shaderSource(d,Re),i.compileShader(d);const n=i.createShader(i.FRAGMENT_SHADER);if(i.shaderSource(n,ve),i.compileShader(n),!i.getShaderParameter(d,i.COMPILE_STATUS))return alert("An error occurred compiling the vert shaders: "+i.getShaderInfoLog(d)),i.deleteShader(d),null;if(!i.getShaderParameter(n,i.COMPILE_STATUS))return alert("An error occurred compiling the frag shaders: "+i.getShaderInfoLog(n)),i.deleteShader(n),null;const s=i.createProgram();if(i.attachShader(s,d),i.attachShader(s,n),i.linkProgram(s),!i.getProgramParameter(s,i.LINK_STATUS))return alert("Unable to initialize the shader program: "+i.getProgramInfoLog(s)),null;const u={program:s,attribLocations:{vertexPosition:i.getAttribLocation(s,"aVertexPosition"),textureCoordPosition:i.getAttribLocation(s,"aTextureCoord")},uniformLocations:{projectionMatrix:i.getUniformLocation(s,"uProjectionMatrix"),modelViewMatrix:i.getUniformLocation(s,"uModelViewMatrix"),texture:i.getUniformLocation(s,"uTexture"),highlight:i.getUniformLocation(s,"uHighlight")}};await Ne(i);const m=f=>{it(u),requestAnimationFrame(m)};requestAnimationFrame(m)}function it(e){i.clearColor(0,0,0,1),i.clearDepth(1),i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);const a=i.canvas.clientHeight/i.canvas.clientWidth,o=.1,c=100,r=M();Me(r,0,v,0,v*a,o,c);const t=Math.floor(b.x/2)-1,d=Math.floor(b.z/2)-5;for(let n=d;n<d+_*2;n++){let s=n*y;for(let u=t;u<t+v*2;u++){let m=s+u;u===F[0]&&n===F[1]?i.uniform1i(e.uniformLocations.highlight,1):i.uniform1i(e.uniformLocations.highlight,0),!(u>=y)&&!(u<0)&&!(n<0)&&!(n>=y)?k(i,L[m],[u,n],e,r,b.cameraMatrix):k(i,254,[u,n],e,r,b.cameraMatrix)}}}

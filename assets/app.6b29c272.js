var dt=Object.defineProperty;var ft=(t,r,i)=>r in t?dt(t,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[r]=i;var m=(t,r,i)=>(ft(t,typeof r!="symbol"?r+"":r,i),i);import"./modulepreload-polyfill.b7f2da20.js";import{c as M,s as W,f as ut,m as ht,t as v,a as lt,r as X,b as B,d as V,e as mt,g as xt,w as D,p as g,o as wt}from"./vendor.9b089b60.js";var pt=`attribute vec4 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat4 uModelViewMatrix;
uniform mat4 uProjectionMatrix;

varying highp vec2 vTextureCoord;

void main(void) {
  gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;
  vTextureCoord = aTextureCoord;
}`,Tt=`varying highp vec2 vTextureCoord;
uniform sampler2D uTexture;

void main(void) {

  gl_FragColor = texture2D(uTexture, vTextureCoord);
  
}`;function vt(t,r){return new Promise((i,c)=>{const o=t.createTexture();t.bindTexture(t.TEXTURE_2D,o);const e=new Image;e.onload=()=>{t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),N(e.width)&&N(e.height)?t.generateMipmap(t.TEXTURE_2D):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),i(o)},e.src=r})}function N(t){return(t&t-1)==0}function u(t,r){return new Promise(async(i,c)=>{const e=await(await fetch(r)).json(),h=e.scenes[e.scene],f=await(await fetch(e.buffers[0].uri)).blob();let l=[...h.nodes],n=0,p=[],_=[],b=[];for(;n<l.length;){let Q=_.length/3;const x=e.nodes[l[n]];if(x.children&&l.push(...x.children),x.mesh!==void 0){let R=M();if(x.scale&&W(R,R,x.scale),x.rotation){const w=M();ut(w,x.rotation),ht(R,R,w)}x.translation&&v(R,R,x.translation);const L=e.meshes[x.mesh].primitives[0],J=L.indices,K=e.accessors[J],F=e.bufferViews[K.bufferView],tt=f.slice(F.byteOffset,F.byteOffset+F.byteLength),et=new Int16Array(await tt.arrayBuffer());p.push(...et.map(w=>w+Q));const at=L.attributes.POSITION,rt=e.accessors[at],C=e.bufferViews[rt.bufferView],it=f.slice(C.byteOffset,C.byteOffset+C.byteLength),P=new Float32Array(await it.arrayBuffer());for(let w=0;w<P.length;w+=3){let U=[P[w],P[w+1],P[w+2]];lt(U,U,R),_.push(...U)}const ot=L.attributes.TEXCOORD_0,st=e.accessors[ot],S=e.bufferViews[st.bufferView],nt=f.slice(S.byteOffset,S.byteOffset+S.byteLength),ct=new Float32Array(await nt.arrayBuffer());b.push(...ct)}n++}const $=await vt(t,e.images[0].uri),I=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,I),t.bufferData(t.ARRAY_BUFFER,new Float32Array(_),t.STATIC_DRAW);const Y=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,Y),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(p),t.STATIC_DRAW);const O=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,O),t.bufferData(t.ARRAY_BUFFER,new Float32Array(b),t.STATIC_DRAW),i({buffers:{index:Y,vertex:I,texCoords:O},indexCount:p.length,texture:$})})}var _t="/taptown/assets/Road-x.25087994.gltf",Rt="/taptown/assets/Road-right.05535041.gltf",Mt="/taptown/assets/Road-left.e4d57c46.gltf",bt="/taptown/assets/Road-y.43b84893.gltf",Et="/taptown/assets/Road-up.f33fbfbe.gltf",At="/taptown/assets/Road-down.3aa34828.gltf",Pt="/taptown/assets/Road-cross.c0149426.gltf",yt="/taptown/assets/Road-upleft.8e8e8992.gltf",Lt="/taptown/assets/Road-leftdown.43e4587d.gltf",Ft="/taptown/assets/Road-downright.2ee19715.gltf",Ct="/taptown/assets/Road-rightup.f9b3a2d6.gltf",St="/taptown/assets/Road-T.dd27be2f.gltf",Ut="/taptown/assets/Road-l-.8fa437e2.gltf",Xt="/taptown/assets/Road--l.cec3388c.gltf",Bt="/taptown/assets/Road-_l_.04dac8e2.gltf",Dt="/taptown/assets/Road-single.f2299542.gltf",It="/taptown/assets/outofbounds.54610d6d.gltf",Yt="/taptown/assets/Cafe.89231c7b.gltf";const d=[null];let j=!1;async function Ot(t){d[1]=await u(t,_t),d[2]=await u(t,Rt),d[3]=await u(t,Mt),d[4]=await u(t,bt),d[5]=await u(t,Et),d[6]=await u(t,At),d[7]=await u(t,Pt),d[8]=await u(t,yt),d[9]=await u(t,Lt),d[10]=await u(t,Ft),d[11]=await u(t,Ct),d[12]=await u(t,St),d[13]=await u(t,Ut),d[14]=await u(t,Xt),d[15]=await u(t,Bt),d[16]=await u(t,Dt),d[254]=await u(t,It),d[255]=await u(t,Yt),j=!0}function z(t,r,[i,c],o,e,h){if(!j)throw"Models aren't loaded!";const s=d[r];if(!s)return;const f=M();v(f,h,[i*2,0,c*2]);{const l=3,n=t.FLOAT,p=!1,_=0,b=0;t.bindBuffer(t.ARRAY_BUFFER,s.buffers.vertex),t.vertexAttribPointer(o.attribLocations.vertexPosition,l,n,p,_,b),t.enableVertexAttribArray(o.attribLocations.vertexPosition)}{const l=2,n=t.FLOAT,p=!1,_=0,b=0;t.bindBuffer(t.ARRAY_BUFFER,s.buffers.texCoords),t.vertexAttribPointer(o.attribLocations.textureCoordPosition,l,n,p,_,b),t.enableVertexAttribArray(o.attribLocations.textureCoordPosition)}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,s.buffers.index),t.useProgram(o.program),t.uniformMatrix4fv(o.uniformLocations.projectionMatrix,!1,e),t.uniformMatrix4fv(o.uniformLocations.modelViewMatrix,!1,f),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,s.texture),t.uniform1i(o.uniformLocations.texture,0),t.drawElements(t.TRIANGLES,s.indexCount,t.UNSIGNED_SHORT,0)}class Wt{constructor(){m(this,"x",0);m(this,"z",0);m(this,"_pointerDown",!1);m(this,"_velocityX",0);m(this,"_velocityY",0);m(this,"_pixelToTileX");m(this,"_pixelToTileZ");m(this,"_prevPointerX");m(this,"_prevPointerY");m(this,"_inFocusMode",!1);m(this,"cameraMatrix",M());v(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),X(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),B(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),document.addEventListener("pointerdown",r=>{this._pointerDown=!0,this._prevPointerX=r.clientX,this._prevPointerY=r.clientY}),document.addEventListener("pointerup",()=>this._pointerDown=!1),document.addEventListener("pointermove",r=>{this._pointerDown&&(this._moveCamera(r.clientX-this._prevPointerX,r.clientY-this._prevPointerY),this._velocityX=r.clientX-this._prevPointerX,this._velocityY=r.clientY-this._prevPointerY),this._prevPointerX=r.clientX,this._prevPointerY=r.clientY})}_moveCamera(r,i){if(this._inFocusMode)return;const c=r/this._pixelToTileX,o=i/this._pixelToTileZ*1.425,e=[c,o];V(e,e,[0,0],45*Math.PI/180),this.x-=e[0],this.z-=e[1],v(this.cameraMatrix,this.cameraMatrix,[e[0],0,e[1]])}setPixelToTileRatio(r,i){this._pixelToTileX=r,this._pixelToTileZ=i}update(r){let i=r/16.66667;this._pointerDown||(this._velocityX=Math.floor(Math.abs(this._velocityX)/10.25*i)*Math.sign(this._velocityX)*10*i,this._velocityY=Math.floor(Math.abs(this._velocityY)/10.25*i)*Math.sign(this._velocityY)*10*i,this._moveCamera(this._velocityX,this._velocityY))}enterFocus([r,i]){this._inFocusMode=!0;const c=Date.now(),o=()=>{let e=(Date.now()-c)/1e3;e>1&&(e=1);const h=45*(1-e)+15*e,s=-this.x*(1-e)+-r*2*e,f=-this.z*(1-e)+-r*2*e,l=1+e;this.cameraMatrix=M(),v(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),X(this.cameraMatrix,this.cameraMatrix,h*Math.PI/180),B(this.cameraMatrix,this.cameraMatrix,h*Math.PI/180),W(this.cameraMatrix,this.cameraMatrix,[l,l,l]),v(this.cameraMatrix,this.cameraMatrix,[s,0,f]),e<1&&requestAnimationFrame(o)};requestAnimationFrame(o)}exitFocus(){this.cameraMatrix=M(),v(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),X(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),B(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),v(this.cameraMatrix,this.cameraMatrix,[-this.x,0,-this.z]),this._inFocusMode=!1}}const Vt=document.querySelector(".money"),gt=document.querySelector(".population");function Nt(t){Vt.textContent=`$${t.money}`,gt.textContent=`${t.population}`}function jt(){return new Worker("/taptown/assets/ambient.6d469442.js",{type:"module"})}function zt(){return new Worker("/taptown/assets/buildings.8e47e127.js",{type:"module"})}function Ht(){return new Worker("/taptown/assets/people.9ab39b39.js",{type:"module"})}let H,k;const E=document.getElementsByTagName("canvas")[0];let A=2*(innerWidth/200),y=2*(innerHeight/200),G,T=new Wt;window.camera=T;E.width=innerWidth;E.height=innerHeight;let Z=innerWidth/A,q=innerHeight/y;T.setPixelToTileRatio(Z,q);const a=E.getContext("webgl");window.addEventListener("resize",()=>{E.width=innerWidth,E.height=innerHeight,A=2*(innerWidth/200),y=2*(innerHeight/200);let t=innerWidth/A,r=innerHeight/y;T.setPixelToTileRatio(t,r)});E.addEventListener("click",t=>{const r=t.clientX/Z/2,i=t.clientY/q/2*1.425,c=[r,i];V(c,c,[0,0],45*Math.PI/180);const o=[T.x/2+3.62,T.z/2-2.62];mt(c,c,o),xt(c,c)});kt();async function kt(){new URLSearchParams(location.search).get("save")||(alert("Save missing or not provided."),location.replace("../"));const i=D(new jt);i.log();const c=D(new zt);c.log();const o=D(new Ht);o.log(),await new i,H=await new c,await H.setCallback(g(n=>{G=n})),k=await new o,await k.setCallback(g(n=>{Nt(n)}));const e=a.createShader(a.VERTEX_SHADER);a.shaderSource(e,pt),a.compileShader(e);const h=a.createShader(a.FRAGMENT_SHADER);if(a.shaderSource(h,Tt),a.compileShader(h),!a.getShaderParameter(e,a.COMPILE_STATUS))return alert("An error occurred compiling the vert shaders: "+a.getShaderInfoLog(e)),a.deleteShader(e),null;if(!a.getShaderParameter(h,a.COMPILE_STATUS))return alert("An error occurred compiling the frag shaders: "+a.getShaderInfoLog(h)),a.deleteShader(h),null;const s=a.createProgram();if(a.attachShader(s,e),a.attachShader(s,h),a.linkProgram(s),!a.getProgramParameter(s,a.LINK_STATUS))return alert("Unable to initialize the shader program: "+a.getProgramInfoLog(s)),null;const f={program:s,attribLocations:{vertexPosition:a.getAttribLocation(s,"aVertexPosition"),textureCoordPosition:a.getAttribLocation(s,"aTextureCoord")},uniformLocations:{projectionMatrix:a.getUniformLocation(s,"uProjectionMatrix"),modelViewMatrix:a.getUniformLocation(s,"uModelViewMatrix"),texture:a.getUniformLocation(s,"uTexture")}};await Ot(a);const l=n=>{Gt(f),requestAnimationFrame(l)};requestAnimationFrame(l)}function Gt(t){a.clearColor(0,0,0,1),a.clearDepth(1),a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);const r=a.canvas.clientHeight/a.canvas.clientWidth,i=.1,c=100,o=M();wt(o,0,A,0,A*r,i,c);const e=20,h=Math.floor(T.x/2)-1,s=Math.floor(T.z/2)-5;for(let f=s;f<s+y*2;f++){let l=f*20;for(let n=h;n<h+A*2;n++){let p=l+n;!(n>=e)&&!(n<0)&&!(f<0)&&!(f>=e)?z(a,G[p],[n,f],t,o,T.cameraMatrix):z(a,254,[n,f],t,o,T.cameraMatrix)}}}

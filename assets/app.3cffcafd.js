var mt=Object.defineProperty;var ht=(t,e,r)=>e in t?mt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var f=(t,e,r)=>(ht(t,typeof e!="symbol"?e+"":e,r),r);import{d as ft,g as ut}from"./db.ba7b3be2.js";import{c as M,s as D,f as wt,m as xt,t as T,a as Ft,r as W,b as S,d as N,e as bt,g as It,w as j,p as O,o as pt}from"./vendor.4f190134.js";var Tt=`attribute vec4 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat4 uModelViewMatrix;
uniform mat4 uProjectionMatrix;

varying highp vec2 vTextureCoord;

void main(void) {
  gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;
  vTextureCoord = aTextureCoord;
}`,Ut=`varying highp vec2 vTextureCoord;
uniform sampler2D uTexture;

uniform bool uHighlight;

void main(void) {

  if (uHighlight) {
    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
  } else {
    gl_FragColor = texture2D(uTexture, vTextureCoord);
  }
  
}`;function Mt(t,e){return new Promise((r,c)=>{const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s);const a=new Image;a.onload=()=>{t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,a),G(a.width)&&G(a.height)?t.generateMipmap(t.TEXTURE_2D):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),r(s)},a.src=e})}function G(t){return(t&t-1)==0}function m(t,e){return new Promise(async(r,c)=>{const a=await(await fetch(e)).json(),u=a.scenes[a.scene],l=await(await fetch(a.buffers[0].uri)).blob();let o=[...u.nodes],w=0,x=[],h=[],R=[];for(;w<o.length;){let K=h.length/3;const F=a.nodes[o[w]];if(F.children&&o.push(...F.children),F.mesh!==void 0){let U=M();if(F.scale&&D(U,U,F.scale),F.rotation){const b=M();wt(b,F.rotation),xt(U,U,b)}F.translation&&T(U,U,F.translation);const X=a.meshes[F.mesh].primitives[0],tt=X.indices,et=a.accessors[tt],V=a.bufferViews[et.bufferView],it=l.slice(V.byteOffset,V.byteOffset+V.byteLength),at=new Int16Array(await it.arrayBuffer());x.push(...at.map(b=>b+K));const rt=X.attributes.POSITION,ot=a.accessors[rt],L=a.bufferViews[ot.bufferView],st=l.slice(L.byteOffset,L.byteOffset+L.byteLength),y=new Float32Array(await st.arrayBuffer());for(let b=0;b<y.length;b+=3){let Z=[y[b],y[b+1],y[b+2]];Ft(Z,Z,U),h.push(...Z)}const nt=X.attributes.TEXCOORD_0,ct=a.accessors[nt],Q=a.bufferViews[ct.bufferView],dt=l.slice(Q.byteOffset,Q.byteOffset+Q.byteLength),lt=new Float32Array(await dt.arrayBuffer());R.push(...lt)}w++}const q=await Mt(t,a.images[0].uri),P=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,P),t.bufferData(t.ARRAY_BUFFER,new Float32Array(h),t.STATIC_DRAW);const J=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,J),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(x),t.STATIC_DRAW);const Y=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,Y),t.bufferData(t.ARRAY_BUFFER,new Float32Array(R),t.STATIC_DRAW),r({buffers:{index:J,vertex:P,texCoords:Y},indexCount:x.length,texture:q})})}var Rt="data:model/gltf+json;base64,eyJhc3NldCI6eyJ2ZXJzaW9uIjoiMi4wIiwiZ2VuZXJhdG9yIjoiQmxvY2tiZW5jaCA0LjEuMSBnbFRGIGV4cG9ydGVyIn0sInNjZW5lcyI6W3sibm9kZXMiOlsxXSwibmFtZSI6ImJsb2NrYmVuY2hfZXhwb3J0In1dLCJzY2VuZSI6MCwibm9kZXMiOlt7Im5hbWUiOiJwbGFuZSIsIm1lc2giOjB9LHsiY2hpbGRyZW4iOlswXX1dLCJidWZmZXJWaWV3cyI6W3siYnVmZmVyIjowLCJieXRlT2Zmc2V0IjowLCJieXRlTGVuZ3RoIjo0OCwidGFyZ2V0IjozNDk2MiwiYnl0ZVN0cmlkZSI6MTJ9LHsiYnVmZmVyIjowLCJieXRlT2Zmc2V0Ijo0OCwiYnl0ZUxlbmd0aCI6NDgsInRhcmdldCI6MzQ5NjIsImJ5dGVTdHJpZGUiOjEyfSx7ImJ1ZmZlciI6MCwiYnl0ZU9mZnNldCI6OTYsImJ5dGVMZW5ndGgiOjMyLCJ0YXJnZXQiOjM0OTYyLCJieXRlU3RyaWRlIjo4fSx7ImJ1ZmZlciI6MCwiYnl0ZU9mZnNldCI6MTI4LCJieXRlTGVuZ3RoIjoxMiwidGFyZ2V0IjozNDk2M31dLCJidWZmZXJzIjpbeyJieXRlTGVuZ3RoIjoxNDAsInVyaSI6ImRhdGE6YXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtO2Jhc2U2NCxBQUFBUUFBQUFBQUFBQUFBQUFBQVFBQUFBQUFBQUFEQUFBQUFBQUFBQUFBQUFBREFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFnRDhBQUFBQUFBQUFBQUFBZ0Q4QUFBQUFBQUFBQUFBQWdEOEFBQUFBQUFBQUFBQUFnRDhBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUNBUHdBQWdEOEFBSUEvQUFDQVB3QUFBQUFBQUFFQUFnQUFBQUlBQXdBPSJ9XSwiYWNjZXNzb3JzIjpbeyJidWZmZXJWaWV3IjowLCJjb21wb25lbnRUeXBlIjo1MTI2LCJjb3VudCI6NCwibWF4IjpbMiwwLDBdLCJtaW4iOlswLDAsLTJdLCJ0eXBlIjoiVkVDMyJ9LHsiYnVmZmVyVmlldyI6MSwiY29tcG9uZW50VHlwZSI6NTEyNiwiY291bnQiOjQsIm1heCI6WzAsMSwwXSwibWluIjpbMCwxLDBdLCJ0eXBlIjoiVkVDMyJ9LHsiYnVmZmVyVmlldyI6MiwiY29tcG9uZW50VHlwZSI6NTEyNiwiY291bnQiOjQsIm1heCI6WzEsMV0sIm1pbiI6WzAsMF0sInR5cGUiOiJWRUMyIn0seyJidWZmZXJWaWV3IjozLCJjb21wb25lbnRUeXBlIjo1MTIzLCJjb3VudCI6NiwibWF4IjpbM10sIm1pbiI6WzBdLCJ0eXBlIjoiU0NBTEFSIn1dLCJtYXRlcmlhbHMiOlt7InBick1ldGFsbGljUm91Z2huZXNzIjp7Im1ldGFsbGljRmFjdG9yIjowLCJyb3VnaG5lc3NGYWN0b3IiOjEsImJhc2VDb2xvclRleHR1cmUiOnsiaW5kZXgiOjB9fSwiYWxwaGFNb2RlIjoiTUFTSyIsImFscGhhQ3V0b2ZmIjowLjA1LCJkb3VibGVTaWRlZCI6dHJ1ZX1dLCJ0ZXh0dXJlcyI6W3sic2FtcGxlciI6MCwic291cmNlIjowLCJuYW1lIjoiZ3Jhc3MifV0sInNhbXBsZXJzIjpbeyJtYWdGaWx0ZXIiOjk3MjgsIm1pbkZpbHRlciI6OTcyOCwid3JhcFMiOjMzMDcxLCJ3cmFwVCI6MzMwNzF9XSwiaW1hZ2VzIjpbeyJtaW1lVHlwZSI6ImltYWdlL3BuZyIsInVyaSI6ImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQ0FBQUFBZ0NBWUFBQUJ6ZW5yMEFBQUFNa2xFUVZSWVIrM1FRUkVBQUFRQVFib2EwZFFraHM5ZWdwdk5tdDU0TEEwUUlFQ0FBQUVDQkFnUUlFQ0FBQUVDM3dJSDRVbE9BVit2UnpVQUFBQUFTVVZPUks1Q1lJST0ifV0sIm1lc2hlcyI6W3sicHJpbWl0aXZlcyI6W3sibW9kZSI6NCwiYXR0cmlidXRlcyI6eyJQT1NJVElPTiI6MCwiTk9STUFMIjoxLCJURVhDT09SRF8wIjoyfSwiaW5kaWNlcyI6MywibWF0ZXJpYWwiOjB9XX1dfQ==",Bt="/taptown/assets/Road-x.25087994.gltf",vt="/taptown/assets/Road-right.05535041.gltf",Et="/taptown/assets/Road-left.e4d57c46.gltf",yt="/taptown/assets/Road-y.43b84893.gltf",Ct="/taptown/assets/Road-up.f33fbfbe.gltf",_t="/taptown/assets/Road-down.3aa34828.gltf",Xt="/taptown/assets/Road-cross.c0149426.gltf",Vt="/taptown/assets/Road-upleft.8e8e8992.gltf",Lt="/taptown/assets/Road-leftdown.43e4587d.gltf",Qt="/taptown/assets/Road-downright.2ee19715.gltf",Zt="/taptown/assets/Road-rightup.f9b3a2d6.gltf",Wt="/taptown/assets/Road-T.dd27be2f.gltf",St="/taptown/assets/Road-l-.8fa437e2.gltf",jt="/taptown/assets/Road--l.cec3388c.gltf",At="/taptown/assets/Road-_l_.04dac8e2.gltf",Pt="/taptown/assets/Road-single.f2299542.gltf",Jt="/taptown/assets/outofbounds.8b7ad541.gltf",Yt="/taptown/assets/Cafe.5a05628e.gltf";const d=[null];let g=!1;async function Dt(t){d[0]=await m(t,Rt),d[1]=await m(t,Bt),d[2]=await m(t,vt),d[3]=await m(t,Et),d[4]=await m(t,yt),d[5]=await m(t,Ct),d[6]=await m(t,_t),d[7]=await m(t,Xt),d[8]=await m(t,Vt),d[9]=await m(t,Lt),d[10]=await m(t,Qt),d[11]=await m(t,Zt),d[12]=await m(t,Wt),d[13]=await m(t,St),d[14]=await m(t,jt),d[15]=await m(t,At),d[16]=await m(t,Pt),d[254]=await m(t,Jt),d[255]=await m(t,Yt),g=!0}function z(t,e,[r,c],s,a,u){if(!g)throw"Models aren't loaded!";const n=d[e];if(!n)return;const l=M();T(l,u,[r*2,0,c*2]);{const o=3,w=t.FLOAT,x=!1,h=0,R=0;t.bindBuffer(t.ARRAY_BUFFER,n.buffers.vertex),t.vertexAttribPointer(s.attribLocations.vertexPosition,o,w,x,h,R),t.enableVertexAttribArray(s.attribLocations.vertexPosition)}{const o=2,w=t.FLOAT,x=!1,h=0,R=0;t.bindBuffer(t.ARRAY_BUFFER,n.buffers.texCoords),t.vertexAttribPointer(s.attribLocations.textureCoordPosition,o,w,x,h,R),t.enableVertexAttribArray(s.attribLocations.textureCoordPosition)}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n.buffers.index),t.useProgram(s.program),t.uniformMatrix4fv(s.uniformLocations.projectionMatrix,!1,a),t.uniformMatrix4fv(s.uniformLocations.modelViewMatrix,!1,l),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,n.texture),t.uniform1i(s.uniformLocations.texture,0),t.drawElements(t.TRIANGLES,n.indexCount,t.UNSIGNED_SHORT,0)}class Nt{constructor(){f(this,"x",0);f(this,"z",0);f(this,"_pointerDown",!1);f(this,"_velocityX",0);f(this,"_velocityY",0);f(this,"_pixelToTileX");f(this,"_pixelToTileZ");f(this,"_prevPointerX");f(this,"_prevPointerY");f(this,"_inFocusMode",!1);f(this,"cameraMatrix",M());T(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),W(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),S(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),document.addEventListener("pointerdown",e=>{this._pointerDown=!0,this._prevPointerX=e.clientX,this._prevPointerY=e.clientY}),document.addEventListener("pointerup",()=>this._pointerDown=!1),document.addEventListener("pointermove",e=>{this._pointerDown&&(this._moveCamera(e.clientX-this._prevPointerX,e.clientY-this._prevPointerY),this._velocityX=e.clientX-this._prevPointerX,this._velocityY=e.clientY-this._prevPointerY),this._prevPointerX=e.clientX,this._prevPointerY=e.clientY})}_moveCamera(e,r){if(this._inFocusMode)return;const c=e/this._pixelToTileX,s=r/this._pixelToTileZ*1.425,a=[c,s];N(a,a,[0,0],45*Math.PI/180),this.x-=a[0],this.z-=a[1],T(this.cameraMatrix,this.cameraMatrix,[a[0],0,a[1]])}setPixelToTileRatio(e,r){this._pixelToTileX=e,this._pixelToTileZ=r}update(e){let r=e/16.66667;this._pointerDown||(this._velocityX=Math.floor(Math.abs(this._velocityX)/10.25*r)*Math.sign(this._velocityX)*10*r,this._velocityY=Math.floor(Math.abs(this._velocityY)/10.25*r)*Math.sign(this._velocityY)*10*r,this._moveCamera(this._velocityX,this._velocityY))}enterFocus([e,r]){this._inFocusMode=!0;const c=Date.now(),s=()=>{let a=(Date.now()-c)/1e3;a>1&&(a=1);const u=-this.x*(1-a)+(-e*2+innerWidth/200)*a,n=-this.z*(1-a)+(-r*2+innerHeight/200)*a,l=1;this.cameraMatrix=M(),T(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),W(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),S(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),D(this.cameraMatrix,this.cameraMatrix,[l,l,l]),T(this.cameraMatrix,this.cameraMatrix,[u,0,n]),a<1&&requestAnimationFrame(s)};requestAnimationFrame(s)}exitFocus(){this.cameraMatrix=M(),T(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),W(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),S(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),T(this.cameraMatrix,this.cameraMatrix,[-this.x,0,-this.z]),this._inFocusMode=!1}}const Ot=document.querySelector(".money"),Gt=document.querySelector(".population");function gt(t){Ot.textContent=`$${t.money}`,Gt.textContent=`${t.population}`}function zt(){return new Worker("/taptown/assets/ambient.6d469442.js",{type:"module"})}function kt(){return new Worker("/taptown/assets/buildings.88119701.js",{type:"module"})}function Ht(){return new Worker("/taptown/assets/people.9ab39b39.js",{type:"module"})}let A,k;const I=document.getElementsByTagName("canvas")[0];let B=2*(innerWidth/200),C=2*(innerHeight/200),_,E,p=new Nt,v=[-100,-100];window.camera=p;I.width=innerWidth*devicePixelRatio;I.height=innerHeight*devicePixelRatio;let H=innerWidth/B,$=innerHeight/C;p.setPixelToTileRatio(H,$);let i=I.getContext("webgl");window.addEventListener("resize",()=>{I.width=innerWidth*devicePixelRatio,I.height=innerHeight*devicePixelRatio,i.viewport(0,0,I.width,I.height),B=2*(innerWidth/200),C=2*(innerHeight/200);let t=innerWidth/B,e=innerHeight/C;p.setPixelToTileRatio(t,e)});I.addEventListener("mousemove",t=>{const e=t.clientX/H/2,r=t.clientY/$/2*1.425,c=[e,r];N(c,c,[0,0],45*Math.PI/180);const s=[p.x/2+3.62,p.z/2-2.62];bt(c,c,s),It(c,c),v=c,console.log(v)});I.addEventListener("click",t=>{const e=v[1]*E+v[0];A.setTile(v[0],v[1],_[e]+1)});$t();async function $t(){const e=new URLSearchParams(location.search).get("save");e||(alert("Save not provided."),location.replace("../"));const r=await ft(),c=await ut(r,e);c||(alert("Save couldn't be loaded."),location.replace("../")),document.title=`\u{1F3E0} ${e} \u2022 TapTown!`,console.log(c);const s=j(new zt);s.log();const a=j(new kt);a.log();const u=j(new Ht);u.log(),await new s,A=await new a(c.map),await A.setCallback(O(h=>{_=h,E=Math.sqrt(_.length)})),k=await new u,await k.setCallback(O(h=>{gt(h)}));const n=i.createShader(i.VERTEX_SHADER);i.shaderSource(n,Tt),i.compileShader(n);const l=i.createShader(i.FRAGMENT_SHADER);if(i.shaderSource(l,Ut),i.compileShader(l),!i.getShaderParameter(n,i.COMPILE_STATUS))return alert("An error occurred compiling the vert shaders: "+i.getShaderInfoLog(n)),i.deleteShader(n),null;if(!i.getShaderParameter(l,i.COMPILE_STATUS))return alert("An error occurred compiling the frag shaders: "+i.getShaderInfoLog(l)),i.deleteShader(l),null;const o=i.createProgram();if(i.attachShader(o,n),i.attachShader(o,l),i.linkProgram(o),!i.getProgramParameter(o,i.LINK_STATUS))return alert("Unable to initialize the shader program: "+i.getProgramInfoLog(o)),null;const w={program:o,attribLocations:{vertexPosition:i.getAttribLocation(o,"aVertexPosition"),textureCoordPosition:i.getAttribLocation(o,"aTextureCoord")},uniformLocations:{projectionMatrix:i.getUniformLocation(o,"uProjectionMatrix"),modelViewMatrix:i.getUniformLocation(o,"uModelViewMatrix"),texture:i.getUniformLocation(o,"uTexture")}};await Dt(i);const x=h=>{qt(w),requestAnimationFrame(x)};requestAnimationFrame(x)}function qt(t){i.clearColor(0,0,0,1),i.clearDepth(1),i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);const e=i.canvas.clientHeight/i.canvas.clientWidth,r=.1,c=100,s=M();pt(s,0,B,0,B*e,r,c);const a=Math.floor(p.x/2)-1,u=Math.floor(p.z/2)-5;for(let n=u;n<u+C*2;n++){let l=n*E;for(let o=a;o<a+B*2;o++){let w=l+o;!(o>=E)&&!(o<0)&&!(n<0)&&!(n>=E)?z(i,_[w],[o,n],t,s,p.cameraMatrix):z(i,254,[o,n],t,s,p.cameraMatrix)}}}

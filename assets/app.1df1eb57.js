var ft=Object.defineProperty;var ut=(t,a,i)=>a in t?ft(t,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[a]=i;var m=(t,a,i)=>(ut(t,typeof a!="symbol"?a+"":a,i),i);import{d as ht,g as lt}from"./db.ffa5ff42.js";import{c as M,s as W,f as mt,m as xt,t as _,a as wt,r as B,b as D,d as N,e as pt,g as Tt,w as I,p as j,o as vt}from"./vendor.9b089b60.js";var _t=`attribute vec4 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat4 uModelViewMatrix;
uniform mat4 uProjectionMatrix;

varying highp vec2 vTextureCoord;

void main(void) {
  gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;
  vTextureCoord = aTextureCoord;
}`,bt=`varying highp vec2 vTextureCoord;
uniform sampler2D uTexture;

void main(void) {

  gl_FragColor = texture2D(uTexture, vTextureCoord);
  
}`;function Mt(t,a){return new Promise((i,c)=>{const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s);const e=new Image;e.onload=()=>{t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),z(e.width)&&z(e.height)?t.generateMipmap(t.TEXTURE_2D):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),i(s)},e.src=a})}function z(t){return(t&t-1)==0}function f(t,a){return new Promise(async(i,c)=>{const e=await(await fetch(a)).json(),h=e.scenes[e.scene],u=await(await fetch(e.buffers[0].uri)).blob();let o=[...h.nodes],x=0,w=[],l=[],R=[];for(;x<o.length;){let J=l.length/3;const p=e.nodes[o[x]];if(p.children&&o.push(...p.children),p.mesh!==void 0){let b=M();if(p.scale&&W(b,b,p.scale),p.rotation){const T=M();mt(T,p.rotation),xt(b,b,T)}p.translation&&_(b,b,p.translation);const L=e.meshes[p.mesh].primitives[0],K=L.indices,tt=e.accessors[K],C=e.bufferViews[tt.bufferView],et=u.slice(C.byteOffset,C.byteOffset+C.byteLength),at=new Int16Array(await et.arrayBuffer());w.push(...at.map(T=>T+J));const rt=L.attributes.POSITION,ot=e.accessors[rt],S=e.bufferViews[ot.bufferView],it=u.slice(S.byteOffset,S.byteOffset+S.byteLength),P=new Float32Array(await it.arrayBuffer());for(let T=0;T<P.length;T+=3){let X=[P[T],P[T+1],P[T+2]];wt(X,X,b),l.push(...X)}const st=L.attributes.TEXCOORD_0,nt=e.accessors[st],U=e.bufferViews[nt.bufferView],ct=u.slice(U.byteOffset,U.byteOffset+U.byteLength),dt=new Float32Array(await ct.arrayBuffer());R.push(...dt)}x++}const Q=await Mt(t,e.images[0].uri),g=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,g),t.bufferData(t.ARRAY_BUFFER,new Float32Array(l),t.STATIC_DRAW);const O=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,O),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(w),t.STATIC_DRAW);const V=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,V),t.bufferData(t.ARRAY_BUFFER,new Float32Array(R),t.STATIC_DRAW),i({buffers:{index:O,vertex:g,texCoords:V},indexCount:w.length,texture:Q})})}var Rt="/taptown/assets/Road-x.25087994.gltf",Et="/taptown/assets/Road-right.05535041.gltf",At="/taptown/assets/Road-left.e4d57c46.gltf",Pt="/taptown/assets/Road-y.43b84893.gltf",yt="/taptown/assets/Road-up.f33fbfbe.gltf",Ft="/taptown/assets/Road-down.3aa34828.gltf",Lt="/taptown/assets/Road-cross.c0149426.gltf",Ct="/taptown/assets/Road-upleft.8e8e8992.gltf",St="/taptown/assets/Road-leftdown.43e4587d.gltf",Ut="/taptown/assets/Road-downright.2ee19715.gltf",Xt="/taptown/assets/Road-rightup.f9b3a2d6.gltf",Bt="/taptown/assets/Road-T.dd27be2f.gltf",Dt="/taptown/assets/Road-l-.8fa437e2.gltf",It="/taptown/assets/Road--l.cec3388c.gltf",Yt="/taptown/assets/Road-_l_.04dac8e2.gltf",gt="/taptown/assets/Road-single.f2299542.gltf",Ot="/taptown/assets/outofbounds.54610d6d.gltf",Vt="/taptown/assets/Cafe.89231c7b.gltf";const d=[null];let H=!1;async function Wt(t){d[1]=await f(t,Rt),d[2]=await f(t,Et),d[3]=await f(t,At),d[4]=await f(t,Pt),d[5]=await f(t,yt),d[6]=await f(t,Ft),d[7]=await f(t,Lt),d[8]=await f(t,Ct),d[9]=await f(t,St),d[10]=await f(t,Ut),d[11]=await f(t,Xt),d[12]=await f(t,Bt),d[13]=await f(t,Dt),d[14]=await f(t,It),d[15]=await f(t,Yt),d[16]=await f(t,gt),d[254]=await f(t,Ot),d[255]=await f(t,Vt),H=!0}function k(t,a,[i,c],s,e,h){if(!H)throw"Models aren't loaded!";const n=d[a];if(!n)return;const u=M();_(u,h,[i*2,0,c*2]);{const o=3,x=t.FLOAT,w=!1,l=0,R=0;t.bindBuffer(t.ARRAY_BUFFER,n.buffers.vertex),t.vertexAttribPointer(s.attribLocations.vertexPosition,o,x,w,l,R),t.enableVertexAttribArray(s.attribLocations.vertexPosition)}{const o=2,x=t.FLOAT,w=!1,l=0,R=0;t.bindBuffer(t.ARRAY_BUFFER,n.buffers.texCoords),t.vertexAttribPointer(s.attribLocations.textureCoordPosition,o,x,w,l,R),t.enableVertexAttribArray(s.attribLocations.textureCoordPosition)}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n.buffers.index),t.useProgram(s.program),t.uniformMatrix4fv(s.uniformLocations.projectionMatrix,!1,e),t.uniformMatrix4fv(s.uniformLocations.modelViewMatrix,!1,u),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,n.texture),t.uniform1i(s.uniformLocations.texture,0),t.drawElements(t.TRIANGLES,n.indexCount,t.UNSIGNED_SHORT,0)}class Nt{constructor(){m(this,"x",0);m(this,"z",0);m(this,"_pointerDown",!1);m(this,"_velocityX",0);m(this,"_velocityY",0);m(this,"_pixelToTileX");m(this,"_pixelToTileZ");m(this,"_prevPointerX");m(this,"_prevPointerY");m(this,"_inFocusMode",!1);m(this,"cameraMatrix",M());_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),B(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),D(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),document.addEventListener("pointerdown",a=>{this._pointerDown=!0,this._prevPointerX=a.clientX,this._prevPointerY=a.clientY}),document.addEventListener("pointerup",()=>this._pointerDown=!1),document.addEventListener("pointermove",a=>{this._pointerDown&&(this._moveCamera(a.clientX-this._prevPointerX,a.clientY-this._prevPointerY),this._velocityX=a.clientX-this._prevPointerX,this._velocityY=a.clientY-this._prevPointerY),this._prevPointerX=a.clientX,this._prevPointerY=a.clientY})}_moveCamera(a,i){if(this._inFocusMode)return;const c=a/this._pixelToTileX,s=i/this._pixelToTileZ*1.425,e=[c,s];N(e,e,[0,0],45*Math.PI/180),this.x-=e[0],this.z-=e[1],_(this.cameraMatrix,this.cameraMatrix,[e[0],0,e[1]])}setPixelToTileRatio(a,i){this._pixelToTileX=a,this._pixelToTileZ=i}update(a){let i=a/16.66667;this._pointerDown||(this._velocityX=Math.floor(Math.abs(this._velocityX)/10.25*i)*Math.sign(this._velocityX)*10*i,this._velocityY=Math.floor(Math.abs(this._velocityY)/10.25*i)*Math.sign(this._velocityY)*10*i,this._moveCamera(this._velocityX,this._velocityY))}enterFocus([a,i]){this._inFocusMode=!0;const c=Date.now(),s=()=>{let e=(Date.now()-c)/1e3;e>1&&(e=1);const h=45*(1-e)+15*e,n=-this.x*(1-e)+-a*2*e,u=-this.z*(1-e)+-a*2*e,o=1+e;this.cameraMatrix=M(),_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),B(this.cameraMatrix,this.cameraMatrix,h*Math.PI/180),D(this.cameraMatrix,this.cameraMatrix,h*Math.PI/180),W(this.cameraMatrix,this.cameraMatrix,[o,o,o]),_(this.cameraMatrix,this.cameraMatrix,[n,0,u]),e<1&&requestAnimationFrame(s)};requestAnimationFrame(s)}exitFocus(){this.cameraMatrix=M(),_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),B(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),D(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),_(this.cameraMatrix,this.cameraMatrix,[-this.x,0,-this.z]),this._inFocusMode=!1}}const jt=document.querySelector(".money"),zt=document.querySelector(".population");function Ht(t){jt.textContent=`$${t.money}`,zt.textContent=`${t.population}`}function kt(){return new Worker("/taptown/assets/ambient.6d469442.js",{type:"module"})}function Gt(){return new Worker("/taptown/assets/buildings.a58a3922.js",{type:"module"})}function $t(){return new Worker("/taptown/assets/people.9ab39b39.js",{type:"module"})}let G,$;const E=document.getElementsByTagName("canvas")[0];let A=2*(innerWidth/200),y=2*(innerHeight/200),Y,F,v=new Nt;window.camera=v;E.width=innerWidth;E.height=innerHeight;let q=innerWidth/A,Z=innerHeight/y;v.setPixelToTileRatio(q,Z);const r=E.getContext("webgl");window.addEventListener("resize",()=>{E.width=innerWidth,E.height=innerHeight,A=2*(innerWidth/200),y=2*(innerHeight/200);let t=innerWidth/A,a=innerHeight/y;v.setPixelToTileRatio(t,a)});E.addEventListener("click",t=>{const a=t.clientX/q/2,i=t.clientY/Z/2*1.425,c=[a,i];N(c,c,[0,0],45*Math.PI/180);const s=[v.x/2+3.62,v.z/2-2.62];pt(c,c,s),Tt(c,c)});qt();async function qt(){const a=new URLSearchParams(location.search).get("save");a||(alert("Save not provided."),location.replace("../"));const i=await ht(),c=await lt(i,a);c||(alert("Save couldn't be loaded."),location.replace("../")),document.title=`\u{1F3E0} ${a} \u2022 TapTown!`,console.log(c);const s=I(new kt);s.log();const e=I(new Gt);e.log();const h=I(new $t);h.log(),await new s,G=await new e(c.map),await G.setCallback(j(l=>{Y=l,F=Math.sqrt(Y.length)})),$=await new h,await $.setCallback(j(l=>{Ht(l)}));const n=r.createShader(r.VERTEX_SHADER);r.shaderSource(n,_t),r.compileShader(n);const u=r.createShader(r.FRAGMENT_SHADER);if(r.shaderSource(u,bt),r.compileShader(u),!r.getShaderParameter(n,r.COMPILE_STATUS))return alert("An error occurred compiling the vert shaders: "+r.getShaderInfoLog(n)),r.deleteShader(n),null;if(!r.getShaderParameter(u,r.COMPILE_STATUS))return alert("An error occurred compiling the frag shaders: "+r.getShaderInfoLog(u)),r.deleteShader(u),null;const o=r.createProgram();if(r.attachShader(o,n),r.attachShader(o,u),r.linkProgram(o),!r.getProgramParameter(o,r.LINK_STATUS))return alert("Unable to initialize the shader program: "+r.getProgramInfoLog(o)),null;const x={program:o,attribLocations:{vertexPosition:r.getAttribLocation(o,"aVertexPosition"),textureCoordPosition:r.getAttribLocation(o,"aTextureCoord")},uniformLocations:{projectionMatrix:r.getUniformLocation(o,"uProjectionMatrix"),modelViewMatrix:r.getUniformLocation(o,"uModelViewMatrix"),texture:r.getUniformLocation(o,"uTexture")}};await Wt(r);const w=l=>{Zt(x),requestAnimationFrame(w)};requestAnimationFrame(w)}function Zt(t){r.clearColor(0,0,0,1),r.clearDepth(1),r.enable(r.DEPTH_TEST),r.depthFunc(r.LEQUAL),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);const a=r.canvas.clientHeight/r.canvas.clientWidth,i=.1,c=100,s=M();vt(s,0,A,0,A*a,i,c);const e=Math.floor(v.x/2)-1,h=Math.floor(v.z/2)-5;for(let n=h;n<h+y*2;n++){let u=n*F;for(let o=e;o<e+A*2;o++){let x=u+o;!(o>=F)&&!(o<0)&&!(n<0)&&!(n>=F)?k(r,Y[x],[o,n],t,s,v.cameraMatrix):k(r,254,[o,n],t,s,v.cameraMatrix)}}}

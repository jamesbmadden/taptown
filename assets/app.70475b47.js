var dt=Object.defineProperty;var ft=(t,r,o)=>r in t?dt(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o;var l=(t,r,o)=>(ft(t,typeof r!="symbol"?r+"":r,o),o);import"./modulepreload-polyfill.b7f2da20.js";import{c as M,s as W,f as ut,m as ht,t as _,a as lt,r as B,b as U,d as V,e as mt,g as xt,w as D,p as g,o as wt}from"./vendor.9b089b60.js";var pt=`attribute vec4 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat4 uModelViewMatrix;
uniform mat4 uProjectionMatrix;

varying highp vec2 vTextureCoord;

void main(void) {
  gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;
  vTextureCoord = aTextureCoord;
}`,Tt=`varying highp vec2 vTextureCoord;
uniform sampler2D uTexture;

void main(void) {

  gl_FragColor = texture2D(uTexture, vTextureCoord);
  
}`;function _t(t,r){return new Promise((o,n)=>{const i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i);const e=new Image;e.onload=()=>{t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),N(e.width)&&N(e.height)?t.generateMipmap(t.TEXTURE_2D):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),o(i)},e.src=r})}function N(t){return(t&t-1)==0}function d(t,r){return new Promise(async(o,n)=>{const e=await(await fetch(r)).json(),m=e.scenes[e.scene],s=await(await fetch(e.buffers[0].uri)).blob();let h=[...m.nodes],u=0,p=[],v=[],b=[];for(;u<h.length;){let Q=v.length/3;const x=e.nodes[h[u]];if(x.children&&h.push(...x.children),x.mesh!==void 0){let R=M();if(x.scale&&W(R,R,x.scale),x.rotation){const w=M();ut(w,x.rotation),ht(R,R,w)}x.translation&&_(R,R,x.translation);const L=e.meshes[x.mesh].primitives[0],J=L.indices,K=e.accessors[J],F=e.bufferViews[K.bufferView],tt=s.slice(F.byteOffset,F.byteOffset+F.byteLength),et=new Int16Array(await tt.arrayBuffer());p.push(...et.map(w=>w+Q));const at=L.attributes.POSITION,rt=e.accessors[at],C=e.bufferViews[rt.bufferView],it=s.slice(C.byteOffset,C.byteOffset+C.byteLength),P=new Float32Array(await it.arrayBuffer());for(let w=0;w<P.length;w+=3){let X=[P[w],P[w+1],P[w+2]];lt(X,X,R),v.push(...X)}const ot=L.attributes.TEXCOORD_0,nt=e.accessors[ot],S=e.bufferViews[nt.bufferView],st=s.slice(S.byteOffset,S.byteOffset+S.byteLength),ct=new Float32Array(await st.arrayBuffer());b.push(...ct)}u++}const $=await _t(t,e.images[0].uri),I=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,I),t.bufferData(t.ARRAY_BUFFER,new Float32Array(v),t.STATIC_DRAW);const Y=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,Y),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(p),t.STATIC_DRAW);const O=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,O),t.bufferData(t.ARRAY_BUFFER,new Float32Array(b),t.STATIC_DRAW),o({buffers:{index:Y,vertex:I,texCoords:O},indexCount:p.length,texture:$})})}var vt="/taptown/assets/Road-x.25087994.gltf",Rt="/taptown/assets/Road-right.05535041.gltf",Mt="/taptown/assets/Road-left.e4d57c46.gltf",bt="/taptown/assets/Road-y.43b84893.gltf",Et="/taptown/assets/Road-up.f33fbfbe.gltf",At="/taptown/assets/Road-down.3aa34828.gltf",Pt="/taptown/assets/Road-cross.c0149426.gltf",yt="/taptown/assets/Road-upleft.8e8e8992.gltf",Lt="/taptown/assets/Road-leftdown.43e4587d.gltf",Ft="/taptown/assets/Road-downright.2ee19715.gltf",Ct="/taptown/assets/Road-rightup.f9b3a2d6.gltf",St="/taptown/assets/Road-T.dd27be2f.gltf",Xt="/taptown/assets/Road-l-.8fa437e2.gltf",Bt="/taptown/assets/Road--l.cec3388c.gltf",Ut="/taptown/assets/Road-_l_.04dac8e2.gltf",Dt="/taptown/assets/Road-single.f2299542.gltf",It="/taptown/assets/outofbounds.54610d6d.gltf",Yt="/taptown/assets/Cafe.89231c7b.gltf";const c=[null];let j=!1;async function Ot(t){c[1]=await d(t,vt),c[2]=await d(t,Rt),c[3]=await d(t,Mt),c[4]=await d(t,bt),c[5]=await d(t,Et),c[6]=await d(t,At),c[7]=await d(t,Pt),c[8]=await d(t,yt),c[9]=await d(t,Lt),c[10]=await d(t,Ft),c[11]=await d(t,Ct),c[12]=await d(t,St),c[13]=await d(t,Xt),c[14]=await d(t,Bt),c[15]=await d(t,Ut),c[16]=await d(t,Dt),c[254]=await d(t,It),c[255]=await d(t,Yt),j=!0}function z(t,r,[o,n],i,e,m){if(!j)throw"Models aren't loaded!";const f=c[r];if(!f)return;const s=M();_(s,m,[o*2,0,n*2]);{const h=3,u=t.FLOAT,p=!1,v=0,b=0;t.bindBuffer(t.ARRAY_BUFFER,f.buffers.vertex),t.vertexAttribPointer(i.attribLocations.vertexPosition,h,u,p,v,b),t.enableVertexAttribArray(i.attribLocations.vertexPosition)}{const h=2,u=t.FLOAT,p=!1,v=0,b=0;t.bindBuffer(t.ARRAY_BUFFER,f.buffers.texCoords),t.vertexAttribPointer(i.attribLocations.textureCoordPosition,h,u,p,v,b),t.enableVertexAttribArray(i.attribLocations.textureCoordPosition)}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,f.buffers.index),t.useProgram(i.program),t.uniformMatrix4fv(i.uniformLocations.projectionMatrix,!1,e),t.uniformMatrix4fv(i.uniformLocations.modelViewMatrix,!1,s),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,f.texture),t.uniform1i(i.uniformLocations.texture,0),t.drawElements(t.TRIANGLES,f.indexCount,t.UNSIGNED_SHORT,0)}class Wt{constructor(){l(this,"x",0);l(this,"z",0);l(this,"_pointerDown",!1);l(this,"_velocityX",0);l(this,"_velocityY",0);l(this,"_pixelToTileX");l(this,"_pixelToTileZ");l(this,"_prevPointerX");l(this,"_prevPointerY");l(this,"_inFocusMode",!1);l(this,"cameraMatrix",M());_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),B(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),U(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),document.addEventListener("pointerdown",r=>{this._pointerDown=!0,this._prevPointerX=r.clientX,this._prevPointerY=r.clientY}),document.addEventListener("pointerup",()=>this._pointerDown=!1),document.addEventListener("pointermove",r=>{this._pointerDown&&(this._moveCamera(r.clientX-this._prevPointerX,r.clientY-this._prevPointerY),this._velocityX=r.clientX-this._prevPointerX,this._velocityY=r.clientY-this._prevPointerY),this._prevPointerX=r.clientX,this._prevPointerY=r.clientY})}_moveCamera(r,o){if(this._inFocusMode)return;const n=r/this._pixelToTileX,i=o/this._pixelToTileZ*1.425,e=[n,i];V(e,e,[0,0],45*Math.PI/180),this.x-=e[0],this.z-=e[1],_(this.cameraMatrix,this.cameraMatrix,[e[0],0,e[1]])}setPixelToTileRatio(r,o){this._pixelToTileX=r,this._pixelToTileZ=o}update(r){let o=r/16.66667;this._pointerDown||(this._velocityX=Math.floor(Math.abs(this._velocityX)/10.25*o)*Math.sign(this._velocityX)*10*o,this._velocityY=Math.floor(Math.abs(this._velocityY)/10.25*o)*Math.sign(this._velocityY)*10*o,this._moveCamera(this._velocityX,this._velocityY))}enterFocus([r,o]){this._inFocusMode=!0;const n=Date.now(),i=()=>{let e=(Date.now()-n)/1e3;e>1&&(e=1);const m=45*(1-e)+15*e,f=-this.x*(1-e)+-r*2*e,s=-this.z*(1-e)+-r*2*e,h=1+e;this.cameraMatrix=M(),_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),B(this.cameraMatrix,this.cameraMatrix,m*Math.PI/180),U(this.cameraMatrix,this.cameraMatrix,m*Math.PI/180),W(this.cameraMatrix,this.cameraMatrix,[h,h,h]),_(this.cameraMatrix,this.cameraMatrix,[f,0,s]),e<1&&requestAnimationFrame(i)};requestAnimationFrame(i)}exitFocus(){this.cameraMatrix=M(),_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),B(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),U(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),_(this.cameraMatrix,this.cameraMatrix,[-this.x,0,-this.z]),this._inFocusMode=!1}}const Vt=document.querySelector(".money"),gt=document.querySelector(".population");function Nt(t){Vt.textContent=`$${t.money}`,gt.textContent=`${t.population}`}function jt(){return new Worker("/taptown/assets/ambient.6d469442.js",{type:"module"})}function zt(){return new Worker("/taptown/assets/buildings.8e47e127.js",{type:"module"})}function Ht(){return new Worker("/taptown/assets/people.9ab39b39.js",{type:"module"})}let H,k;const E=document.getElementsByTagName("canvas")[0];let A=2*(innerWidth/200),y=2*(innerHeight/200),G,T=new Wt;window.camera=T;E.width=innerWidth;E.height=innerHeight;let Z=innerWidth/A,q=innerHeight/y;T.setPixelToTileRatio(Z,q);const a=E.getContext("webgl");window.addEventListener("resize",()=>{E.width=innerWidth,E.height=innerHeight,A=2*(innerWidth/200),y=2*(innerHeight/200);let t=innerWidth/A,r=innerHeight/y;T.setPixelToTileRatio(t,r)});E.addEventListener("click",t=>{const r=t.clientX/Z/2,o=t.clientY/q/2*1.425,n=[r,o];V(n,n,[0,0],45*Math.PI/180);const i=[T.x/2+3.62,T.z/2-2.62];mt(n,n,i),xt(n,n)});kt();async function kt(){const t=D(new jt);t.log();const r=D(new zt);r.log();const o=D(new Ht);o.log(),await new t,H=await new r,await H.setCallback(g(s=>{G=s})),k=await new o,await k.setCallback(g(s=>{Nt(s)}));const n=a.createShader(a.VERTEX_SHADER);a.shaderSource(n,pt),a.compileShader(n);const i=a.createShader(a.FRAGMENT_SHADER);if(a.shaderSource(i,Tt),a.compileShader(i),!a.getShaderParameter(n,a.COMPILE_STATUS))return alert("An error occurred compiling the vert shaders: "+a.getShaderInfoLog(n)),a.deleteShader(n),null;if(!a.getShaderParameter(i,a.COMPILE_STATUS))return alert("An error occurred compiling the frag shaders: "+a.getShaderInfoLog(i)),a.deleteShader(i),null;const e=a.createProgram();if(a.attachShader(e,n),a.attachShader(e,i),a.linkProgram(e),!a.getProgramParameter(e,a.LINK_STATUS))return alert("Unable to initialize the shader program: "+a.getProgramInfoLog(e)),null;const m={program:e,attribLocations:{vertexPosition:a.getAttribLocation(e,"aVertexPosition"),textureCoordPosition:a.getAttribLocation(e,"aTextureCoord")},uniformLocations:{projectionMatrix:a.getUniformLocation(e,"uProjectionMatrix"),modelViewMatrix:a.getUniformLocation(e,"uModelViewMatrix"),texture:a.getUniformLocation(e,"uTexture")}};await Ot(a);const f=s=>{Gt(m),requestAnimationFrame(f)};requestAnimationFrame(f)}function Gt(t){a.clearColor(0,0,0,1),a.clearDepth(1),a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);const r=a.canvas.clientHeight/a.canvas.clientWidth,o=.1,n=100,i=M();wt(i,0,A,0,A*r,o,n);const e=20,m=Math.floor(T.x/2)-1,f=Math.floor(T.z/2)-5;for(let s=f;s<f+y*2;s++){let h=s*20;for(let u=m;u<m+A*2;u++){let p=h+u;!(u>=e)&&!(u<0)&&!(s<0)&&!(s>=e)?z(a,G[p],[u,s],t,i,T.cameraMatrix):z(a,254,[u,s],t,i,T.cameraMatrix)}}}

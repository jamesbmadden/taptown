var lt=Object.defineProperty;var mt=(t,i,o)=>i in t?lt(t,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[i]=o;var u=(t,i,o)=>(mt(t,typeof i!="symbol"?i+"":i,o),o);import{d as ft,g as ht}from"./db.ba7b3be2.js";import{c as M,s as Y,f as ut,m as wt,t as p,a as xt,r as Z,b as S,d as D,e as Ft,g as bt,w as W,p as N,o as It}from"./vendor.4f190134.js";var pt=`attribute vec4 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat4 uModelViewMatrix;
uniform mat4 uProjectionMatrix;

varying highp vec2 vTextureCoord;

void main(void) {
  gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;
  vTextureCoord = aTextureCoord;
}`,Tt=`varying highp vec2 vTextureCoord;
uniform sampler2D uTexture;

void main(void) {

  gl_FragColor = texture2D(uTexture, vTextureCoord);
  
}`;function Ut(t,i){return new Promise((o,n)=>{const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s);const e=new Image;e.onload=()=>{t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),O(e.width)&&O(e.height)?t.generateMipmap(t.TEXTURE_2D):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),o(s)},e.src=i})}function O(t){return(t&t-1)==0}function l(t,i){return new Promise(async(o,n)=>{const e=await(await fetch(i)).json(),f=e.scenes[e.scene],m=await(await fetch(e.buffers[0].uri)).blob();let r=[...f.nodes],w=0,x=[],h=[],R=[];for(;w<r.length;){let q=h.length/3;const F=e.nodes[r[w]];if(F.children&&r.push(...F.children),F.mesh!==void 0){let U=M();if(F.scale&&Y(U,U,F.scale),F.rotation){const b=M();ut(b,F.rotation),wt(U,U,b)}F.translation&&p(U,U,F.translation);const _=e.meshes[F.mesh].primitives[0],K=_.indices,tt=e.accessors[K],V=e.bufferViews[tt.bufferView],et=m.slice(V.byteOffset,V.byteOffset+V.byteLength),at=new Int16Array(await et.arrayBuffer());x.push(...at.map(b=>b+q));const it=_.attributes.POSITION,rt=e.accessors[it],X=e.bufferViews[rt.bufferView],ot=m.slice(X.byteOffset,X.byteOffset+X.byteLength),y=new Float32Array(await ot.arrayBuffer());for(let b=0;b<y.length;b+=3){let Q=[y[b],y[b+1],y[b+2]];xt(Q,Q,U),h.push(...Q)}const st=_.attributes.TEXCOORD_0,nt=e.accessors[st],L=e.bufferViews[nt.bufferView],ct=m.slice(L.byteOffset,L.byteOffset+L.byteLength),dt=new Float32Array(await ct.arrayBuffer());R.push(...dt)}w++}const $=await Ut(t,e.images[0].uri),A=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,A),t.bufferData(t.ARRAY_BUFFER,new Float32Array(h),t.STATIC_DRAW);const P=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,P),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(x),t.STATIC_DRAW);const J=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,J),t.bufferData(t.ARRAY_BUFFER,new Float32Array(R),t.STATIC_DRAW),o({buffers:{index:P,vertex:A,texCoords:J},indexCount:x.length,texture:$})})}var Mt="data:model/gltf+json;base64,eyJhc3NldCI6eyJ2ZXJzaW9uIjoiMi4wIiwiZ2VuZXJhdG9yIjoiQmxvY2tiZW5jaCA0LjEuMSBnbFRGIGV4cG9ydGVyIn0sInNjZW5lcyI6W3sibm9kZXMiOlsxXSwibmFtZSI6ImJsb2NrYmVuY2hfZXhwb3J0In1dLCJzY2VuZSI6MCwibm9kZXMiOlt7Im5hbWUiOiJwbGFuZSIsIm1lc2giOjB9LHsiY2hpbGRyZW4iOlswXX1dLCJidWZmZXJWaWV3cyI6W3siYnVmZmVyIjowLCJieXRlT2Zmc2V0IjowLCJieXRlTGVuZ3RoIjo0OCwidGFyZ2V0IjozNDk2MiwiYnl0ZVN0cmlkZSI6MTJ9LHsiYnVmZmVyIjowLCJieXRlT2Zmc2V0Ijo0OCwiYnl0ZUxlbmd0aCI6NDgsInRhcmdldCI6MzQ5NjIsImJ5dGVTdHJpZGUiOjEyfSx7ImJ1ZmZlciI6MCwiYnl0ZU9mZnNldCI6OTYsImJ5dGVMZW5ndGgiOjMyLCJ0YXJnZXQiOjM0OTYyLCJieXRlU3RyaWRlIjo4fSx7ImJ1ZmZlciI6MCwiYnl0ZU9mZnNldCI6MTI4LCJieXRlTGVuZ3RoIjoxMiwidGFyZ2V0IjozNDk2M31dLCJidWZmZXJzIjpbeyJieXRlTGVuZ3RoIjoxNDAsInVyaSI6ImRhdGE6YXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtO2Jhc2U2NCxBQUFBUUFBQUFBQUFBQUFBQUFBQVFBQUFBQUFBQUFEQUFBQUFBQUFBQUFBQUFBREFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFnRDhBQUFBQUFBQUFBQUFBZ0Q4QUFBQUFBQUFBQUFBQWdEOEFBQUFBQUFBQUFBQUFnRDhBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUNBUHdBQWdEOEFBSUEvQUFDQVB3QUFBQUFBQUFFQUFnQUFBQUlBQXdBPSJ9XSwiYWNjZXNzb3JzIjpbeyJidWZmZXJWaWV3IjowLCJjb21wb25lbnRUeXBlIjo1MTI2LCJjb3VudCI6NCwibWF4IjpbMiwwLDBdLCJtaW4iOlswLDAsLTJdLCJ0eXBlIjoiVkVDMyJ9LHsiYnVmZmVyVmlldyI6MSwiY29tcG9uZW50VHlwZSI6NTEyNiwiY291bnQiOjQsIm1heCI6WzAsMSwwXSwibWluIjpbMCwxLDBdLCJ0eXBlIjoiVkVDMyJ9LHsiYnVmZmVyVmlldyI6MiwiY29tcG9uZW50VHlwZSI6NTEyNiwiY291bnQiOjQsIm1heCI6WzEsMV0sIm1pbiI6WzAsMF0sInR5cGUiOiJWRUMyIn0seyJidWZmZXJWaWV3IjozLCJjb21wb25lbnRUeXBlIjo1MTIzLCJjb3VudCI6NiwibWF4IjpbM10sIm1pbiI6WzBdLCJ0eXBlIjoiU0NBTEFSIn1dLCJtYXRlcmlhbHMiOlt7InBick1ldGFsbGljUm91Z2huZXNzIjp7Im1ldGFsbGljRmFjdG9yIjowLCJyb3VnaG5lc3NGYWN0b3IiOjEsImJhc2VDb2xvclRleHR1cmUiOnsiaW5kZXgiOjB9fSwiYWxwaGFNb2RlIjoiTUFTSyIsImFscGhhQ3V0b2ZmIjowLjA1LCJkb3VibGVTaWRlZCI6dHJ1ZX1dLCJ0ZXh0dXJlcyI6W3sic2FtcGxlciI6MCwic291cmNlIjowLCJuYW1lIjoiZ3Jhc3MifV0sInNhbXBsZXJzIjpbeyJtYWdGaWx0ZXIiOjk3MjgsIm1pbkZpbHRlciI6OTcyOCwid3JhcFMiOjMzMDcxLCJ3cmFwVCI6MzMwNzF9XSwiaW1hZ2VzIjpbeyJtaW1lVHlwZSI6ImltYWdlL3BuZyIsInVyaSI6ImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQ0FBQUFBZ0NBWUFBQUJ6ZW5yMEFBQUFNa2xFUVZSWVIrM1FRUkVBQUFRQVFib2EwZFFraHM5ZWdwdk5tdDU0TEEwUUlFQ0FBQUVDQkFnUUlFQ0FBQUVDM3dJSDRVbE9BVit2UnpVQUFBQUFTVVZPUks1Q1lJST0ifV0sIm1lc2hlcyI6W3sicHJpbWl0aXZlcyI6W3sibW9kZSI6NCwiYXR0cmlidXRlcyI6eyJQT1NJVElPTiI6MCwiTk9STUFMIjoxLCJURVhDT09SRF8wIjoyfSwiaW5kaWNlcyI6MywibWF0ZXJpYWwiOjB9XX1dfQ==",Rt="/taptown/assets/Road-x.25087994.gltf",Bt="/taptown/assets/Road-right.05535041.gltf",vt="/taptown/assets/Road-left.e4d57c46.gltf",yt="/taptown/assets/Road-y.43b84893.gltf",Et="/taptown/assets/Road-up.f33fbfbe.gltf",Ct="/taptown/assets/Road-down.3aa34828.gltf",_t="/taptown/assets/Road-cross.c0149426.gltf",Vt="/taptown/assets/Road-upleft.8e8e8992.gltf",Xt="/taptown/assets/Road-leftdown.43e4587d.gltf",Lt="/taptown/assets/Road-downright.2ee19715.gltf",Qt="/taptown/assets/Road-rightup.f9b3a2d6.gltf",Zt="/taptown/assets/Road-T.dd27be2f.gltf",St="/taptown/assets/Road-l-.8fa437e2.gltf",Wt="/taptown/assets/Road--l.cec3388c.gltf",jt="/taptown/assets/Road-_l_.04dac8e2.gltf",At="/taptown/assets/Road-single.f2299542.gltf",Pt="/taptown/assets/outofbounds.8b7ad541.gltf",Jt="/taptown/assets/Cafe.5a05628e.gltf";const d=[null];let G=!1;async function Yt(t){d[0]=await l(t,Mt),d[1]=await l(t,Rt),d[2]=await l(t,Bt),d[3]=await l(t,vt),d[4]=await l(t,yt),d[5]=await l(t,Et),d[6]=await l(t,Ct),d[7]=await l(t,_t),d[8]=await l(t,Vt),d[9]=await l(t,Xt),d[10]=await l(t,Lt),d[11]=await l(t,Qt),d[12]=await l(t,Zt),d[13]=await l(t,St),d[14]=await l(t,Wt),d[15]=await l(t,jt),d[16]=await l(t,At),d[254]=await l(t,Pt),d[255]=await l(t,Jt),G=!0}function z(t,i,[o,n],s,e,f){if(!G)throw"Models aren't loaded!";const c=d[i];if(!c)return;const m=M();p(m,f,[o*2,0,n*2]);{const r=3,w=t.FLOAT,x=!1,h=0,R=0;t.bindBuffer(t.ARRAY_BUFFER,c.buffers.vertex),t.vertexAttribPointer(s.attribLocations.vertexPosition,r,w,x,h,R),t.enableVertexAttribArray(s.attribLocations.vertexPosition)}{const r=2,w=t.FLOAT,x=!1,h=0,R=0;t.bindBuffer(t.ARRAY_BUFFER,c.buffers.texCoords),t.vertexAttribPointer(s.attribLocations.textureCoordPosition,r,w,x,h,R),t.enableVertexAttribArray(s.attribLocations.textureCoordPosition)}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,c.buffers.index),t.useProgram(s.program),t.uniformMatrix4fv(s.uniformLocations.projectionMatrix,!1,e),t.uniformMatrix4fv(s.uniformLocations.modelViewMatrix,!1,m),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,c.texture),t.uniform1i(s.uniformLocations.texture,0),t.drawElements(t.TRIANGLES,c.indexCount,t.UNSIGNED_SHORT,0)}class Dt{constructor(){u(this,"x",0);u(this,"z",0);u(this,"_pointerDown",!1);u(this,"_velocityX",0);u(this,"_velocityY",0);u(this,"_pixelToTileX");u(this,"_pixelToTileZ");u(this,"_prevPointerX");u(this,"_prevPointerY");u(this,"_inFocusMode",!1);u(this,"cameraMatrix",M());p(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),Z(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),S(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),document.addEventListener("pointerdown",i=>{this._pointerDown=!0,this._prevPointerX=i.clientX,this._prevPointerY=i.clientY}),document.addEventListener("pointerup",()=>this._pointerDown=!1),document.addEventListener("pointermove",i=>{this._pointerDown&&(this._moveCamera(i.clientX-this._prevPointerX,i.clientY-this._prevPointerY),this._velocityX=i.clientX-this._prevPointerX,this._velocityY=i.clientY-this._prevPointerY),this._prevPointerX=i.clientX,this._prevPointerY=i.clientY})}_moveCamera(i,o){if(this._inFocusMode)return;const n=i/this._pixelToTileX,s=o/this._pixelToTileZ*1.425,e=[n,s];D(e,e,[0,0],45*Math.PI/180),this.x-=e[0],this.z-=e[1],p(this.cameraMatrix,this.cameraMatrix,[e[0],0,e[1]])}setPixelToTileRatio(i,o){this._pixelToTileX=i,this._pixelToTileZ=o}update(i){let o=i/16.66667;this._pointerDown||(this._velocityX=Math.floor(Math.abs(this._velocityX)/10.25*o)*Math.sign(this._velocityX)*10*o,this._velocityY=Math.floor(Math.abs(this._velocityY)/10.25*o)*Math.sign(this._velocityY)*10*o,this._moveCamera(this._velocityX,this._velocityY))}enterFocus([i,o]){this._inFocusMode=!0;const n=Date.now(),s=()=>{let e=(Date.now()-n)/1e3;e>1&&(e=1);const f=45*(1-e)+15*e,c=-this.x*(1-e)+-i*2*e,m=-this.z*(1-e)+-i*2*e,r=1+e;this.cameraMatrix=M(),p(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),Z(this.cameraMatrix,this.cameraMatrix,f*Math.PI/180),S(this.cameraMatrix,this.cameraMatrix,f*Math.PI/180),Y(this.cameraMatrix,this.cameraMatrix,[r,r,r]),p(this.cameraMatrix,this.cameraMatrix,[c,0,m]),e<1&&requestAnimationFrame(s)};requestAnimationFrame(s)}exitFocus(){this.cameraMatrix=M(),p(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),Z(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),S(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),p(this.cameraMatrix,this.cameraMatrix,[-this.x,0,-this.z]),this._inFocusMode=!1}}const Nt=document.querySelector(".money"),Ot=document.querySelector(".population");function Gt(t){Nt.textContent=`$${t.money}`,Ot.textContent=`${t.population}`}function zt(){return new Worker("/taptown/assets/ambient.6d469442.js",{type:"module"})}function kt(){return new Worker("/taptown/assets/buildings.88119701.js",{type:"module"})}function gt(){return new Worker("/taptown/assets/people.9ab39b39.js",{type:"module"})}let j,k;const T=document.getElementsByTagName("canvas")[0];let B=2*(innerWidth/200),E=2*(innerHeight/200),C,v,I=new Dt;window.camera=I;T.width=innerWidth*devicePixelRatio;T.height=innerHeight*devicePixelRatio;let g=innerWidth/B,H=innerHeight/E;I.setPixelToTileRatio(g,H);let a=T.getContext("webgl");window.addEventListener("resize",()=>{T.width=innerWidth*devicePixelRatio,T.height=innerHeight*devicePixelRatio,a.viewport(0,0,T.width,T.height),B=2*(innerWidth/200),E=2*(innerHeight/200);let t=innerWidth/B,i=innerHeight/E;I.setPixelToTileRatio(t,i)});T.addEventListener("click",t=>{const i=t.clientX/g/2,o=t.clientY/H/2*1.425,n=[i,o];D(n,n,[0,0],45*Math.PI/180);const s=[I.x/2+3.62,I.z/2-2.62];Ft(n,n,s),bt(n,n);const e=n[1]*v+n[0];j.setTile(n[0],n[1],C[e]+1)});Ht();async function Ht(){const i=new URLSearchParams(location.search).get("save");i||(alert("Save not provided."),location.replace("../"));const o=await ft(),n=await ht(o,i);n||(alert("Save couldn't be loaded."),location.replace("../")),document.title=`\u{1F3E0} ${i} \u2022 TapTown!`,console.log(n);const s=W(new zt);s.log();const e=W(new kt);e.log();const f=W(new gt);f.log(),await new s,j=await new e(n.map),await j.setCallback(N(h=>{C=h,v=Math.sqrt(C.length)})),k=await new f,await k.setCallback(N(h=>{Gt(h)}));const c=a.createShader(a.VERTEX_SHADER);a.shaderSource(c,pt),a.compileShader(c);const m=a.createShader(a.FRAGMENT_SHADER);if(a.shaderSource(m,Tt),a.compileShader(m),!a.getShaderParameter(c,a.COMPILE_STATUS))return alert("An error occurred compiling the vert shaders: "+a.getShaderInfoLog(c)),a.deleteShader(c),null;if(!a.getShaderParameter(m,a.COMPILE_STATUS))return alert("An error occurred compiling the frag shaders: "+a.getShaderInfoLog(m)),a.deleteShader(m),null;const r=a.createProgram();if(a.attachShader(r,c),a.attachShader(r,m),a.linkProgram(r),!a.getProgramParameter(r,a.LINK_STATUS))return alert("Unable to initialize the shader program: "+a.getProgramInfoLog(r)),null;const w={program:r,attribLocations:{vertexPosition:a.getAttribLocation(r,"aVertexPosition"),textureCoordPosition:a.getAttribLocation(r,"aTextureCoord")},uniformLocations:{projectionMatrix:a.getUniformLocation(r,"uProjectionMatrix"),modelViewMatrix:a.getUniformLocation(r,"uModelViewMatrix"),texture:a.getUniformLocation(r,"uTexture")}};await Yt(a);const x=h=>{$t(w),requestAnimationFrame(x)};requestAnimationFrame(x)}function $t(t){a.clearColor(0,0,0,1),a.clearDepth(1),a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);const i=a.canvas.clientHeight/a.canvas.clientWidth,o=.1,n=100,s=M();It(s,0,B,0,B*i,o,n);const e=Math.floor(I.x/2)-1,f=Math.floor(I.z/2)-5;for(let c=f;c<f+E*2;c++){let m=c*v;for(let r=e;r<e+B*2;r++){let w=m+r;!(r>=v)&&!(r<0)&&!(c<0)&&!(c>=v)?z(a,C[w],[r,c],t,s,I.cameraMatrix):z(a,254,[r,c],t,s,I.cameraMatrix)}}}

var de=Object.defineProperty;var fe=(e,i,a)=>i in e?de(e,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[i]=a;var h=(e,i,a)=>(fe(e,typeof i!="symbol"?i+"":i,a),a);import{c as E,s as W,f as ue,m as le,t as _,a as me,r as B,b as U,d as V,e as he,g as xe,w as D,p as N,o as Te}from"./vendor.1a4694db.js";const we=function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const t of r)if(t.type==="childList")for(const f of t.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&n(f)}).observe(document,{childList:!0,subtree:!0});function a(r){const t={};return r.integrity&&(t.integrity=r.integrity),r.referrerpolicy&&(t.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?t.credentials="include":r.crossorigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function n(r){if(r.ep)return;r.ep=!0;const t=a(r);fetch(r.href,t)}};we();var pe=`attribute vec4 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat4 uModelViewMatrix;
uniform mat4 uProjectionMatrix;

varying highp vec2 vTextureCoord;

void main(void) {
  gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;
  vTextureCoord = aTextureCoord;
}`,_e=`varying highp vec2 vTextureCoord;
uniform sampler2D uTexture;

void main(void) {

  gl_FragColor = texture2D(uTexture, vTextureCoord);
  
}`;function Me(e,i){return new Promise((a,n)=>{const r=e.createTexture();e.bindTexture(e.TEXTURE_2D,r);const t=new Image;t.onload=()=>{e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),g(t.width)&&g(t.height)?e.generateMipmap(e.TEXTURE_2D):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),a(r)},t.src=i})}function g(e){return(e&e-1)==0}function d(e,i){return new Promise(async(a,n)=>{const t=await(await fetch(i)).json(),f=t.scenes[t.scene],s=await(await fetch(t.buffers[0].uri)).blob();let m=[...f.nodes],l=0,w=[],M=[],b=[];for(;l<m.length;){let Q=M.length/3;const x=t.nodes[m[l]];if(x.children&&m.push(...x.children),x.mesh!==void 0){let R=E();if(x.scale&&W(R,R,x.scale),x.rotation){const T=E();ue(T,x.rotation),le(R,R,T)}x.translation&&_(R,R,x.translation);const L=t.meshes[x.mesh].primitives[0],K=L.indices,J=t.accessors[K],F=t.bufferViews[J.bufferView],ee=s.slice(F.byteOffset,F.byteOffset+F.byteLength),te=new Int16Array(await ee.arrayBuffer());w.push(...te.map(T=>T+Q));const re=L.attributes.POSITION,ie=t.accessors[re],C=t.bufferViews[ie.bufferView],oe=s.slice(C.byteOffset,C.byteOffset+C.byteLength),P=new Float32Array(await oe.arrayBuffer());for(let T=0;T<P.length;T+=3){let X=[P[T],P[T+1],P[T+2]];me(X,X,R),M.push(...X)}const ae=L.attributes.TEXCOORD_0,ne=t.accessors[ae],S=t.bufferViews[ne.bufferView],se=s.slice(S.byteOffset,S.byteOffset+S.byteLength),ce=new Float32Array(await se.arrayBuffer());b.push(...ce)}l++}const $=await Me(e,t.images[0].uri),I=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,I),e.bufferData(e.ARRAY_BUFFER,new Float32Array(M),e.STATIC_DRAW);const Y=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,Y),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(w),e.STATIC_DRAW);const O=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,O),e.bufferData(e.ARRAY_BUFFER,new Float32Array(b),e.STATIC_DRAW),a({buffers:{index:Y,vertex:I,texCoords:O},indexCount:w.length,texture:$})})}const c=[null];let j=!1;async function Re(e){c[1]=await d(e,"/models/Road-x.gltf"),c[2]=await d(e,"/models/Road-right.gltf"),c[3]=await d(e,"/models/Road-left.gltf"),c[4]=await d(e,"/models/Road-y.gltf"),c[5]=await d(e,"/models/Road-up.gltf"),c[6]=await d(e,"/models/Road-down.gltf"),c[7]=await d(e,"/models/Road-cross.gltf"),c[8]=await d(e,"/models/Road-upleft.gltf"),c[9]=await d(e,"/models/Road-leftdown.gltf"),c[10]=await d(e,"/models/Road-downright.gltf"),c[11]=await d(e,"/models/Road-rightup.gltf"),c[12]=await d(e,"/models/Road-T.gltf"),c[13]=await d(e,"/models/Road-l-.gltf"),c[14]=await d(e,"/models/Road--l.gltf"),c[15]=await d(e,"/models/Road-_l_.gltf"),c[16]=await d(e,"/models/Road-single.gltf"),c[254]=await d(e,"/models/outofbounds.gltf"),c[255]=await d(e,"/models/Cafe.gltf"),j=!0}function z(e,i,[a,n],r,t,f){if(!j)throw"Models aren't loaded!";const u=c[i];if(!u)return;const s=E();_(s,f,[a*2,0,n*2]);{const m=3,l=e.FLOAT,w=!1,M=0,b=0;e.bindBuffer(e.ARRAY_BUFFER,u.buffers.vertex),e.vertexAttribPointer(r.attribLocations.vertexPosition,m,l,w,M,b),e.enableVertexAttribArray(r.attribLocations.vertexPosition)}{const m=2,l=e.FLOAT,w=!1,M=0,b=0;e.bindBuffer(e.ARRAY_BUFFER,u.buffers.texCoords),e.vertexAttribPointer(r.attribLocations.textureCoordPosition,m,l,w,M,b),e.enableVertexAttribArray(r.attribLocations.textureCoordPosition)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,u.buffers.index),e.useProgram(r.program),e.uniformMatrix4fv(r.uniformLocations.projectionMatrix,!1,t),e.uniformMatrix4fv(r.uniformLocations.modelViewMatrix,!1,s),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,u.texture),e.uniform1i(r.uniformLocations.texture,0),e.drawElements(e.TRIANGLES,u.indexCount,e.UNSIGNED_SHORT,0)}class Ee{constructor(){h(this,"x",0);h(this,"z",0);h(this,"_pointerDown",!1);h(this,"_velocityX",0);h(this,"_velocityY",0);h(this,"_pixelToTileX");h(this,"_pixelToTileZ");h(this,"_prevPointerX");h(this,"_prevPointerY");h(this,"_inFocusMode",!1);h(this,"cameraMatrix",E());_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),B(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),U(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),document.addEventListener("pointerdown",i=>{this._pointerDown=!0,this._prevPointerX=i.clientX,this._prevPointerY=i.clientY}),document.addEventListener("pointerup",()=>this._pointerDown=!1),document.addEventListener("pointermove",i=>{this._pointerDown&&(this._moveCamera(i.clientX-this._prevPointerX,i.clientY-this._prevPointerY),this._velocityX=i.clientX-this._prevPointerX,this._velocityY=i.clientY-this._prevPointerY),this._prevPointerX=i.clientX,this._prevPointerY=i.clientY})}_moveCamera(i,a){if(this._inFocusMode)return;const n=i/this._pixelToTileX,r=a/this._pixelToTileZ*1.425,t=[n,r];V(t,t,[0,0],45*Math.PI/180),this.x-=t[0],this.z-=t[1],_(this.cameraMatrix,this.cameraMatrix,[t[0],0,t[1]])}setPixelToTileRatio(i,a){this._pixelToTileX=i,this._pixelToTileZ=a}update(i){let a=i/16.66667;this._pointerDown||(this._velocityX=Math.floor(Math.abs(this._velocityX)/10.25*a)*Math.sign(this._velocityX)*10*a,this._velocityY=Math.floor(Math.abs(this._velocityY)/10.25*a)*Math.sign(this._velocityY)*10*a,this._moveCamera(this._velocityX,this._velocityY))}enterFocus([i,a]){this._inFocusMode=!0;const n=Date.now(),r=()=>{let t=(Date.now()-n)/1e3;t>1&&(t=1);const f=45*(1-t)+15*t,u=-this.x*(1-t)+-i*2*t,s=-this.z*(1-t)+-i*2*t,m=1+t;this.cameraMatrix=E(),_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),B(this.cameraMatrix,this.cameraMatrix,f*Math.PI/180),U(this.cameraMatrix,this.cameraMatrix,f*Math.PI/180),W(this.cameraMatrix,this.cameraMatrix,[m,m,m]),_(this.cameraMatrix,this.cameraMatrix,[u,0,s]),t<1&&requestAnimationFrame(r)};requestAnimationFrame(r)}exitFocus(){this.cameraMatrix=E(),_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),B(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),U(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),_(this.cameraMatrix,this.cameraMatrix,[-this.x,0,-this.z]),this._inFocusMode=!1}}const be=document.querySelector(".money"),ve=document.querySelector(".population");function Ae(e){be.textContent=`$${e.money}`,ve.textContent=`${e.population}`}function Pe(){return new Worker("/taptown/assets/ambient.6d469442.js",{type:"module"})}function ye(){return new Worker("/taptown/assets/buildings.8e47e127.js",{type:"module"})}function Le(){return new Worker("/taptown/assets/people.9ab39b39.js",{type:"module"})}let H,k;const v=document.getElementsByTagName("canvas")[0];let A=2*(innerWidth/200),y=2*(innerHeight/200),G,p=new Ee;window.camera=p;v.width=innerWidth;v.height=innerHeight;let q=innerWidth/A,Z=innerHeight/y;p.setPixelToTileRatio(q,Z);const o=v.getContext("webgl");window.addEventListener("resize",()=>{v.width=innerWidth,v.height=innerHeight,A=2*(innerWidth/200),y=2*(innerHeight/200);let e=innerWidth/A,i=innerHeight/y;p.setPixelToTileRatio(e,i)});v.addEventListener("click",e=>{const i=e.clientX/q/2,a=e.clientY/Z/2*1.425,n=[i,a];V(n,n,[0,0],45*Math.PI/180);const r=[p.x/2+3.62,p.z/2-2.62];he(n,n,r),xe(n,n)});Fe();async function Fe(){const e=D(new Pe);e.log();const i=D(new ye);i.log();const a=D(new Le);a.log(),await new e,H=await new i,await H.setCallback(N(s=>{G=s})),k=await new a,await k.setCallback(N(s=>{Ae(s)}));const n=o.createShader(o.VERTEX_SHADER);o.shaderSource(n,pe),o.compileShader(n);const r=o.createShader(o.FRAGMENT_SHADER);if(o.shaderSource(r,_e),o.compileShader(r),!o.getShaderParameter(n,o.COMPILE_STATUS))return alert("An error occurred compiling the vert shaders: "+o.getShaderInfoLog(n)),o.deleteShader(n),null;if(!o.getShaderParameter(r,o.COMPILE_STATUS))return alert("An error occurred compiling the frag shaders: "+o.getShaderInfoLog(r)),o.deleteShader(r),null;const t=o.createProgram();if(o.attachShader(t,n),o.attachShader(t,r),o.linkProgram(t),!o.getProgramParameter(t,o.LINK_STATUS))return alert("Unable to initialize the shader program: "+o.getProgramInfoLog(t)),null;const f={program:t,attribLocations:{vertexPosition:o.getAttribLocation(t,"aVertexPosition"),textureCoordPosition:o.getAttribLocation(t,"aTextureCoord")},uniformLocations:{projectionMatrix:o.getUniformLocation(t,"uProjectionMatrix"),modelViewMatrix:o.getUniformLocation(t,"uModelViewMatrix"),texture:o.getUniformLocation(t,"uTexture")}};await Re(o);const u=s=>{Ce(f),requestAnimationFrame(u)};requestAnimationFrame(u)}function Ce(e){o.clearColor(0,0,0,1),o.clearDepth(1),o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);const i=o.canvas.clientHeight/o.canvas.clientWidth,a=.1,n=100,r=E();Te(r,0,A,0,A*i,a,n);const t=20,f=Math.floor(p.x/2)-1,u=Math.floor(p.z/2)-5;for(let s=u;s<u+y*2;s++){let m=s*20;for(let l=f;l<f+A*2;l++){let w=m+l;!(l>=t)&&!(l<0)&&!(s<0)&&!(s>=t)?z(o,G[w],[l,s],e,r,p.cameraMatrix):z(o,254,[l,s],e,r,p.cameraMatrix)}}}

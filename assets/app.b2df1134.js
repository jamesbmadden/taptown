var ft=Object.defineProperty;var ut=(t,a,o)=>a in t?ft(t,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[a]=o;var m=(t,a,o)=>(ut(t,typeof a!="symbol"?a+"":a,o),o);import{d as ht,g as lt}from"./db.ba7b3be2.js";import{c as b,s as N,f as mt,m as xt,t as _,a as wt,r as D,b as I,d as j,e as pt,g as Tt,w as Y,p as z,o as vt}from"./vendor.4f190134.js";var _t=`attribute vec4 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat4 uModelViewMatrix;
uniform mat4 uProjectionMatrix;

varying highp vec2 vTextureCoord;

void main(void) {
  gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;
  vTextureCoord = aTextureCoord;
}`,Rt=`varying highp vec2 vTextureCoord;
uniform sampler2D uTexture;

void main(void) {

  gl_FragColor = texture2D(uTexture, vTextureCoord);
  
}`;function bt(t,a){return new Promise((o,n)=>{const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s);const e=new Image;e.onload=()=>{t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),H(e.width)&&H(e.height)?t.generateMipmap(t.TEXTURE_2D):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),o(s)},e.src=a})}function H(t){return(t&t-1)==0}function f(t,a){return new Promise(async(o,n)=>{const e=await(await fetch(a)).json(),h=e.scenes[e.scene],u=await(await fetch(e.buffers[0].uri)).blob();let i=[...h.nodes],x=0,w=[],l=[],M=[];for(;x<i.length;){let J=l.length/3;const p=e.nodes[i[x]];if(p.children&&i.push(...p.children),p.mesh!==void 0){let R=b();if(p.scale&&N(R,R,p.scale),p.rotation){const T=b();mt(T,p.rotation),xt(R,R,T)}p.translation&&_(R,R,p.translation);const C=e.meshes[p.mesh].primitives[0],K=C.indices,tt=e.accessors[K],S=e.bufferViews[tt.bufferView],et=u.slice(S.byteOffset,S.byteOffset+S.byteLength),at=new Int16Array(await et.arrayBuffer());w.push(...at.map(T=>T+J));const rt=C.attributes.POSITION,it=e.accessors[rt],U=e.bufferViews[it.bufferView],ot=u.slice(U.byteOffset,U.byteOffset+U.byteLength),y=new Float32Array(await ot.arrayBuffer());for(let T=0;T<y.length;T+=3){let B=[y[T],y[T+1],y[T+2]];wt(B,B,R),l.push(...B)}const st=C.attributes.TEXCOORD_0,nt=e.accessors[st],X=e.bufferViews[nt.bufferView],ct=u.slice(X.byteOffset,X.byteOffset+X.byteLength),dt=new Float32Array(await ct.arrayBuffer());M.push(...dt)}x++}const Q=await bt(t,e.images[0].uri),O=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,O),t.bufferData(t.ARRAY_BUFFER,new Float32Array(l),t.STATIC_DRAW);const V=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,V),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(w),t.STATIC_DRAW);const W=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,W),t.bufferData(t.ARRAY_BUFFER,new Float32Array(M),t.STATIC_DRAW),o({buffers:{index:V,vertex:O,texCoords:W},indexCount:w.length,texture:Q})})}var Mt="/taptown/assets/Road-x.25087994.gltf",Et="/taptown/assets/Road-right.05535041.gltf",Pt="/taptown/assets/Road-left.e4d57c46.gltf",At="/taptown/assets/Road-y.43b84893.gltf",yt="/taptown/assets/Road-up.f33fbfbe.gltf",Ft="/taptown/assets/Road-down.3aa34828.gltf",Lt="/taptown/assets/Road-cross.c0149426.gltf",Ct="/taptown/assets/Road-upleft.8e8e8992.gltf",St="/taptown/assets/Road-leftdown.43e4587d.gltf",Ut="/taptown/assets/Road-downright.2ee19715.gltf",Xt="/taptown/assets/Road-rightup.f9b3a2d6.gltf",Bt="/taptown/assets/Road-T.dd27be2f.gltf",Dt="/taptown/assets/Road-l-.8fa437e2.gltf",It="/taptown/assets/Road--l.cec3388c.gltf",Yt="/taptown/assets/Road-_l_.04dac8e2.gltf",gt="/taptown/assets/Road-single.f2299542.gltf",Ot="/taptown/assets/outofbounds.54610d6d.gltf",Vt="/taptown/assets/Cafe.89231c7b.gltf";const d=[null];let k=!1;async function Wt(t){d[1]=await f(t,Mt),d[2]=await f(t,Et),d[3]=await f(t,Pt),d[4]=await f(t,At),d[5]=await f(t,yt),d[6]=await f(t,Ft),d[7]=await f(t,Lt),d[8]=await f(t,Ct),d[9]=await f(t,St),d[10]=await f(t,Ut),d[11]=await f(t,Xt),d[12]=await f(t,Bt),d[13]=await f(t,Dt),d[14]=await f(t,It),d[15]=await f(t,Yt),d[16]=await f(t,gt),d[254]=await f(t,Ot),d[255]=await f(t,Vt),k=!0}function G(t,a,[o,n],s,e,h){if(!k)throw"Models aren't loaded!";const c=d[a];if(!c)return;const u=b();_(u,h,[o*2,0,n*2]);{const i=3,x=t.FLOAT,w=!1,l=0,M=0;t.bindBuffer(t.ARRAY_BUFFER,c.buffers.vertex),t.vertexAttribPointer(s.attribLocations.vertexPosition,i,x,w,l,M),t.enableVertexAttribArray(s.attribLocations.vertexPosition)}{const i=2,x=t.FLOAT,w=!1,l=0,M=0;t.bindBuffer(t.ARRAY_BUFFER,c.buffers.texCoords),t.vertexAttribPointer(s.attribLocations.textureCoordPosition,i,x,w,l,M),t.enableVertexAttribArray(s.attribLocations.textureCoordPosition)}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,c.buffers.index),t.useProgram(s.program),t.uniformMatrix4fv(s.uniformLocations.projectionMatrix,!1,e),t.uniformMatrix4fv(s.uniformLocations.modelViewMatrix,!1,u),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,c.texture),t.uniform1i(s.uniformLocations.texture,0),t.drawElements(t.TRIANGLES,c.indexCount,t.UNSIGNED_SHORT,0)}class Nt{constructor(){m(this,"x",0);m(this,"z",0);m(this,"_pointerDown",!1);m(this,"_velocityX",0);m(this,"_velocityY",0);m(this,"_pixelToTileX");m(this,"_pixelToTileZ");m(this,"_prevPointerX");m(this,"_prevPointerY");m(this,"_inFocusMode",!1);m(this,"cameraMatrix",b());_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),D(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),I(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),document.addEventListener("pointerdown",a=>{this._pointerDown=!0,this._prevPointerX=a.clientX,this._prevPointerY=a.clientY}),document.addEventListener("pointerup",()=>this._pointerDown=!1),document.addEventListener("pointermove",a=>{this._pointerDown&&(this._moveCamera(a.clientX-this._prevPointerX,a.clientY-this._prevPointerY),this._velocityX=a.clientX-this._prevPointerX,this._velocityY=a.clientY-this._prevPointerY),this._prevPointerX=a.clientX,this._prevPointerY=a.clientY})}_moveCamera(a,o){if(this._inFocusMode)return;const n=a/this._pixelToTileX,s=o/this._pixelToTileZ*1.425,e=[n,s];j(e,e,[0,0],45*Math.PI/180),this.x-=e[0],this.z-=e[1],_(this.cameraMatrix,this.cameraMatrix,[e[0],0,e[1]])}setPixelToTileRatio(a,o){this._pixelToTileX=a,this._pixelToTileZ=o}update(a){let o=a/16.66667;this._pointerDown||(this._velocityX=Math.floor(Math.abs(this._velocityX)/10.25*o)*Math.sign(this._velocityX)*10*o,this._velocityY=Math.floor(Math.abs(this._velocityY)/10.25*o)*Math.sign(this._velocityY)*10*o,this._moveCamera(this._velocityX,this._velocityY))}enterFocus([a,o]){this._inFocusMode=!0;const n=Date.now(),s=()=>{let e=(Date.now()-n)/1e3;e>1&&(e=1);const h=45*(1-e)+15*e,c=-this.x*(1-e)+-a*2*e,u=-this.z*(1-e)+-a*2*e,i=1+e;this.cameraMatrix=b(),_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),D(this.cameraMatrix,this.cameraMatrix,h*Math.PI/180),I(this.cameraMatrix,this.cameraMatrix,h*Math.PI/180),N(this.cameraMatrix,this.cameraMatrix,[i,i,i]),_(this.cameraMatrix,this.cameraMatrix,[c,0,u]),e<1&&requestAnimationFrame(s)};requestAnimationFrame(s)}exitFocus(){this.cameraMatrix=b(),_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),D(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),I(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),_(this.cameraMatrix,this.cameraMatrix,[-this.x,0,-this.z]),this._inFocusMode=!1}}const jt=document.querySelector(".money"),zt=document.querySelector(".population");function Ht(t){jt.textContent=`$${t.money}`,zt.textContent=`${t.population}`}function kt(){return new Worker("/taptown/assets/ambient.6d469442.js",{type:"module"})}function Gt(){return new Worker("/taptown/assets/buildings.88119701.js",{type:"module"})}function $t(){return new Worker("/taptown/assets/people.9ab39b39.js",{type:"module"})}let g,$;const E=document.getElementsByTagName("canvas")[0];let P=2*(innerWidth/200),F=2*(innerHeight/200),L,A,v=new Nt;window.camera=v;E.width=innerWidth*devicePixelRatio;E.height=innerHeight*devicePixelRatio;let q=innerWidth/P,Z=innerHeight/F;v.setPixelToTileRatio(q,Z);const r=E.getContext("webgl");window.addEventListener("resize",()=>{E.width=innerWidth*devicePixelRatio,E.height=innerHeight*devicePixelRatio,P=2*(innerWidth/200),F=2*(innerHeight/200);let t=innerWidth/P,a=innerHeight/F;v.setPixelToTileRatio(t,a)});E.addEventListener("click",t=>{const a=t.clientX/q/2,o=t.clientY/Z/2*1.425,n=[a,o];j(n,n,[0,0],45*Math.PI/180);const s=[v.x/2+3.62,v.z/2-2.62];pt(n,n,s),Tt(n,n);const e=n[1]*A+n[0];g.setTile(n[0],n[1],L[e]+1)});qt();async function qt(){const a=new URLSearchParams(location.search).get("save");a||(alert("Save not provided."),location.replace("../"));const o=await ht(),n=await lt(o,a);n||(alert("Save couldn't be loaded."),location.replace("../")),document.title=`\u{1F3E0} ${a} \u2022 TapTown!`,console.log(n);const s=Y(new kt);s.log();const e=Y(new Gt);e.log();const h=Y(new $t);h.log(),await new s,g=await new e(n.map),await g.setCallback(z(l=>{L=l,A=Math.sqrt(L.length)})),$=await new h,await $.setCallback(z(l=>{Ht(l)}));const c=r.createShader(r.VERTEX_SHADER);r.shaderSource(c,_t),r.compileShader(c);const u=r.createShader(r.FRAGMENT_SHADER);if(r.shaderSource(u,Rt),r.compileShader(u),!r.getShaderParameter(c,r.COMPILE_STATUS))return alert("An error occurred compiling the vert shaders: "+r.getShaderInfoLog(c)),r.deleteShader(c),null;if(!r.getShaderParameter(u,r.COMPILE_STATUS))return alert("An error occurred compiling the frag shaders: "+r.getShaderInfoLog(u)),r.deleteShader(u),null;const i=r.createProgram();if(r.attachShader(i,c),r.attachShader(i,u),r.linkProgram(i),!r.getProgramParameter(i,r.LINK_STATUS))return alert("Unable to initialize the shader program: "+r.getProgramInfoLog(i)),null;const x={program:i,attribLocations:{vertexPosition:r.getAttribLocation(i,"aVertexPosition"),textureCoordPosition:r.getAttribLocation(i,"aTextureCoord")},uniformLocations:{projectionMatrix:r.getUniformLocation(i,"uProjectionMatrix"),modelViewMatrix:r.getUniformLocation(i,"uModelViewMatrix"),texture:r.getUniformLocation(i,"uTexture")}};await Wt(r);const w=l=>{Zt(x),requestAnimationFrame(w)};requestAnimationFrame(w)}function Zt(t){r.clearColor(0,0,0,1),r.clearDepth(1),r.enable(r.DEPTH_TEST),r.depthFunc(r.LEQUAL),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);const a=r.canvas.clientHeight/r.canvas.clientWidth,o=.1,n=100,s=b();vt(s,0,P,0,P*a,o,n);const e=Math.floor(v.x/2)-1,h=Math.floor(v.z/2)-5;for(let c=h;c<h+F*2;c++){let u=c*A;for(let i=e;i<e+P*2;i++){let x=u+i;!(i>=A)&&!(i<0)&&!(c<0)&&!(c>=A)?G(r,L[x],[i,c],t,s,v.cameraMatrix):G(r,254,[i,c],t,s,v.cameraMatrix)}}}

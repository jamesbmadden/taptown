var ht=Object.defineProperty;var mt=(t,i,o)=>i in t?ht(t,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[i]=o;var w=(t,i,o)=>(mt(t,typeof i!="symbol"?i+"":i,o),o);import"./modulepreload-polyfill.b7f2da20.js";import{c as M,s as D,f as ut,m as ft,t as p,a as wt,r as S,b as j,d as N,e as xt,g as Ft,w as A,p as O,o as bt}from"./vendor.a32a625e.js";var It=`attribute vec4 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat4 uModelViewMatrix;
uniform mat4 uProjectionMatrix;

varying highp vec2 vTextureCoord;

void main(void) {
  gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;
  vTextureCoord = aTextureCoord;
}`,pt=`varying highp vec2 vTextureCoord;
uniform sampler2D uTexture;

uniform bool uHighlight;

void main(void) {

  if (uHighlight) {
    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
  } else {
    gl_FragColor = texture2D(uTexture, vTextureCoord);
  }
  
}`;function Ut(t,i){return new Promise((o,l)=>{const r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r);const a=new Image;a.onload=()=>{t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,a),G(a.width)&&G(a.height)?t.generateMipmap(t.TEXTURE_2D):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),o(r)},a.src=i})}function G(t){return(t&t-1)==0}function d(t,i){return new Promise(async(o,l)=>{const a=await(await fetch(i)).json(),m=a.scenes[a.scene],s=await(await fetch(a.buffers[0].uri)).blob();let h=[...m.nodes],u=0,f=[],U=[],B=[];for(;u<h.length;){let K=U.length/3;const x=a.nodes[h[u]];if(x.children&&h.push(...x.children),x.mesh!==void 0){let T=M();if(x.scale&&D(T,T,x.scale),x.rotation){const F=M();ut(F,x.rotation),ft(T,T,F)}x.translation&&p(T,T,x.translation);const X=a.meshes[x.mesh].primitives[0],tt=X.indices,et=a.accessors[tt],V=a.bufferViews[et.bufferView],it=s.slice(V.byteOffset,V.byteOffset+V.byteLength),at=new Int16Array(await it.arrayBuffer());f.push(...at.map(F=>F+K));const ot=X.attributes.POSITION,rt=a.accessors[ot],Q=a.bufferViews[rt.bufferView],nt=s.slice(Q.byteOffset,Q.byteOffset+Q.byteLength),E=new Float32Array(await nt.arrayBuffer());for(let F=0;F<E.length;F+=3){let W=[E[F],E[F+1],E[F+2]];wt(W,W,T),U.push(...W)}const st=X.attributes.TEXCOORD_0,ct=a.accessors[st],Z=a.bufferViews[ct.bufferView],dt=s.slice(Z.byteOffset,Z.byteOffset+Z.byteLength),lt=new Float32Array(await dt.arrayBuffer());B.push(...lt)}u++}const $=await Ut(t,a.images[0].uri),P=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,P),t.bufferData(t.ARRAY_BUFFER,new Float32Array(U),t.STATIC_DRAW);const J=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,J),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(f),t.STATIC_DRAW);const Y=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,Y),t.bufferData(t.ARRAY_BUFFER,new Float32Array(B),t.STATIC_DRAW),o({buffers:{index:J,vertex:P,texCoords:Y},indexCount:f.length,texture:$})})}var Tt="data:model/gltf+json;base64,eyJhc3NldCI6eyJ2ZXJzaW9uIjoiMi4wIiwiZ2VuZXJhdG9yIjoiQmxvY2tiZW5jaCA0LjEuMSBnbFRGIGV4cG9ydGVyIn0sInNjZW5lcyI6W3sibm9kZXMiOlsxXSwibmFtZSI6ImJsb2NrYmVuY2hfZXhwb3J0In1dLCJzY2VuZSI6MCwibm9kZXMiOlt7Im5hbWUiOiJwbGFuZSIsIm1lc2giOjB9LHsiY2hpbGRyZW4iOlswXX1dLCJidWZmZXJWaWV3cyI6W3siYnVmZmVyIjowLCJieXRlT2Zmc2V0IjowLCJieXRlTGVuZ3RoIjo0OCwidGFyZ2V0IjozNDk2MiwiYnl0ZVN0cmlkZSI6MTJ9LHsiYnVmZmVyIjowLCJieXRlT2Zmc2V0Ijo0OCwiYnl0ZUxlbmd0aCI6NDgsInRhcmdldCI6MzQ5NjIsImJ5dGVTdHJpZGUiOjEyfSx7ImJ1ZmZlciI6MCwiYnl0ZU9mZnNldCI6OTYsImJ5dGVMZW5ndGgiOjMyLCJ0YXJnZXQiOjM0OTYyLCJieXRlU3RyaWRlIjo4fSx7ImJ1ZmZlciI6MCwiYnl0ZU9mZnNldCI6MTI4LCJieXRlTGVuZ3RoIjoxMiwidGFyZ2V0IjozNDk2M31dLCJidWZmZXJzIjpbeyJieXRlTGVuZ3RoIjoxNDAsInVyaSI6ImRhdGE6YXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtO2Jhc2U2NCxBQUFBUUFBQUFBQUFBQUFBQUFBQVFBQUFBQUFBQUFEQUFBQUFBQUFBQUFBQUFBREFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFnRDhBQUFBQUFBQUFBQUFBZ0Q4QUFBQUFBQUFBQUFBQWdEOEFBQUFBQUFBQUFBQUFnRDhBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUNBUHdBQWdEOEFBSUEvQUFDQVB3QUFBQUFBQUFFQUFnQUFBQUlBQXdBPSJ9XSwiYWNjZXNzb3JzIjpbeyJidWZmZXJWaWV3IjowLCJjb21wb25lbnRUeXBlIjo1MTI2LCJjb3VudCI6NCwibWF4IjpbMiwwLDBdLCJtaW4iOlswLDAsLTJdLCJ0eXBlIjoiVkVDMyJ9LHsiYnVmZmVyVmlldyI6MSwiY29tcG9uZW50VHlwZSI6NTEyNiwiY291bnQiOjQsIm1heCI6WzAsMSwwXSwibWluIjpbMCwxLDBdLCJ0eXBlIjoiVkVDMyJ9LHsiYnVmZmVyVmlldyI6MiwiY29tcG9uZW50VHlwZSI6NTEyNiwiY291bnQiOjQsIm1heCI6WzEsMV0sIm1pbiI6WzAsMF0sInR5cGUiOiJWRUMyIn0seyJidWZmZXJWaWV3IjozLCJjb21wb25lbnRUeXBlIjo1MTIzLCJjb3VudCI6NiwibWF4IjpbM10sIm1pbiI6WzBdLCJ0eXBlIjoiU0NBTEFSIn1dLCJtYXRlcmlhbHMiOlt7InBick1ldGFsbGljUm91Z2huZXNzIjp7Im1ldGFsbGljRmFjdG9yIjowLCJyb3VnaG5lc3NGYWN0b3IiOjEsImJhc2VDb2xvclRleHR1cmUiOnsiaW5kZXgiOjB9fSwiYWxwaGFNb2RlIjoiTUFTSyIsImFscGhhQ3V0b2ZmIjowLjA1LCJkb3VibGVTaWRlZCI6dHJ1ZX1dLCJ0ZXh0dXJlcyI6W3sic2FtcGxlciI6MCwic291cmNlIjowLCJuYW1lIjoiZ3Jhc3MifV0sInNhbXBsZXJzIjpbeyJtYWdGaWx0ZXIiOjk3MjgsIm1pbkZpbHRlciI6OTcyOCwid3JhcFMiOjMzMDcxLCJ3cmFwVCI6MzMwNzF9XSwiaW1hZ2VzIjpbeyJtaW1lVHlwZSI6ImltYWdlL3BuZyIsInVyaSI6ImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQ0FBQUFBZ0NBWUFBQUJ6ZW5yMEFBQUFNa2xFUVZSWVIrM1FRUkVBQUFRQVFib2EwZFFraHM5ZWdwdk5tdDU0TEEwUUlFQ0FBQUVDQkFnUUlFQ0FBQUVDM3dJSDRVbE9BVit2UnpVQUFBQUFTVVZPUks1Q1lJST0ifV0sIm1lc2hlcyI6W3sicHJpbWl0aXZlcyI6W3sibW9kZSI6NCwiYXR0cmlidXRlcyI6eyJQT1NJVElPTiI6MCwiTk9STUFMIjoxLCJURVhDT09SRF8wIjoyfSwiaW5kaWNlcyI6MywibWF0ZXJpYWwiOjB9XX1dfQ==",Mt="/taptown/assets/Road-x.25087994.gltf",Rt="/taptown/assets/Road-right.05535041.gltf",Bt="/taptown/assets/Road-left.e4d57c46.gltf",vt="/taptown/assets/Road-y.43b84893.gltf",yt="/taptown/assets/Road-up.f33fbfbe.gltf",Et="/taptown/assets/Road-down.3aa34828.gltf",Ct="/taptown/assets/Road-cross.c0149426.gltf",_t="/taptown/assets/Road-upleft.8e8e8992.gltf",Lt="/taptown/assets/Road-leftdown.43e4587d.gltf",Xt="/taptown/assets/Road-downright.2ee19715.gltf",Vt="/taptown/assets/Road-rightup.f9b3a2d6.gltf",Qt="/taptown/assets/Road-T.dd27be2f.gltf",Zt="/taptown/assets/Road-l-.8fa437e2.gltf",Wt="/taptown/assets/Road--l.cec3388c.gltf",St="/taptown/assets/Road-_l_.04dac8e2.gltf",jt="/taptown/assets/Road-single.f2299542.gltf",At="/taptown/assets/outofbounds.8b7ad541.gltf",Pt="/taptown/assets/Cafe.5a05628e.gltf";const c=[null];let g=!1;async function Jt(t){c[0]=await d(t,Tt),c[1]=await d(t,Mt),c[2]=await d(t,Rt),c[3]=await d(t,Bt),c[4]=await d(t,vt),c[5]=await d(t,yt),c[6]=await d(t,Et),c[7]=await d(t,Ct),c[8]=await d(t,_t),c[9]=await d(t,Lt),c[10]=await d(t,Xt),c[11]=await d(t,Vt),c[12]=await d(t,Qt),c[13]=await d(t,Zt),c[14]=await d(t,Wt),c[15]=await d(t,St),c[16]=await d(t,jt),c[254]=await d(t,At),c[255]=await d(t,Pt),g=!0}function z(t,i,[o,l],r,a,m){if(!g)throw"Models aren't loaded!";const n=c[i];if(!n)return;const s=M();p(s,m,[o*2,0,l*2]);{const h=3,u=t.FLOAT,f=!1,U=0,B=0;t.bindBuffer(t.ARRAY_BUFFER,n.buffers.vertex),t.vertexAttribPointer(r.attribLocations.vertexPosition,h,u,f,U,B),t.enableVertexAttribArray(r.attribLocations.vertexPosition)}{const h=2,u=t.FLOAT,f=!1,U=0,B=0;t.bindBuffer(t.ARRAY_BUFFER,n.buffers.texCoords),t.vertexAttribPointer(r.attribLocations.textureCoordPosition,h,u,f,U,B),t.enableVertexAttribArray(r.attribLocations.textureCoordPosition)}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n.buffers.index),t.useProgram(r.program),t.uniformMatrix4fv(r.uniformLocations.projectionMatrix,!1,a),t.uniformMatrix4fv(r.uniformLocations.modelViewMatrix,!1,s),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,n.texture),t.uniform1i(r.uniformLocations.texture,0),t.drawElements(t.TRIANGLES,n.indexCount,t.UNSIGNED_SHORT,0)}class Yt{constructor(){w(this,"x",0);w(this,"z",0);w(this,"_pointerDown",!1);w(this,"_velocityX",0);w(this,"_velocityY",0);w(this,"_pixelToTileX");w(this,"_pixelToTileZ");w(this,"_prevPointerX");w(this,"_prevPointerY");w(this,"_inFocusMode",!1);w(this,"cameraMatrix",M());p(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),S(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),j(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),document.addEventListener("pointerdown",i=>{this._pointerDown=!0,this._prevPointerX=i.clientX,this._prevPointerY=i.clientY}),document.addEventListener("pointerup",()=>this._pointerDown=!1),document.addEventListener("pointermove",i=>{this._pointerDown&&(this._moveCamera(i.clientX-this._prevPointerX,i.clientY-this._prevPointerY),this._velocityX=i.clientX-this._prevPointerX,this._velocityY=i.clientY-this._prevPointerY),this._prevPointerX=i.clientX,this._prevPointerY=i.clientY})}_moveCamera(i,o){if(this._inFocusMode)return;const l=i/this._pixelToTileX,r=o/this._pixelToTileZ*1.425,a=[l,r];N(a,a,[0,0],45*Math.PI/180),this.x-=a[0],this.z-=a[1],p(this.cameraMatrix,this.cameraMatrix,[a[0],0,a[1]])}setPixelToTileRatio(i,o){this._pixelToTileX=i,this._pixelToTileZ=o}update(i){let o=i/16.66667;this._pointerDown||(this._velocityX=Math.floor(Math.abs(this._velocityX)/10.25*o)*Math.sign(this._velocityX)*10*o,this._velocityY=Math.floor(Math.abs(this._velocityY)/10.25*o)*Math.sign(this._velocityY)*10*o,this._moveCamera(this._velocityX,this._velocityY))}enterFocus([i,o]){this._inFocusMode=!0;const l=Date.now(),r=()=>{let a=(Date.now()-l)/1e3;a>1&&(a=1);const m=-this.x*(1-a)+(-i*2+innerWidth/200)*a,n=-this.z*(1-a)+(-o*2+innerHeight/200)*a,s=1;this.cameraMatrix=M(),p(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),S(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),j(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),D(this.cameraMatrix,this.cameraMatrix,[s,s,s]),p(this.cameraMatrix,this.cameraMatrix,[m,0,n]),a<1&&requestAnimationFrame(r)};requestAnimationFrame(r)}exitFocus(){this.cameraMatrix=M(),p(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),S(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),j(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),p(this.cameraMatrix,this.cameraMatrix,[-this.x,0,-this.z]),this._inFocusMode=!1}}const Dt=document.querySelector(".money"),Nt=document.querySelector(".population");function Ot(t){Dt.textContent=`$${t.money}`,Nt.textContent=`${t.population}`}function Gt(){return new Worker("/taptown/assets/ambient.6d469442.js",{type:"module"})}function gt(){return new Worker("/taptown/assets/buildings.b834db88.js",{type:"module"})}function zt(){return new Worker("/taptown/assets/people.9ab39b39.js",{type:"module"})}let C,H;const b=document.getElementsByTagName("canvas")[0];let v=2*(innerWidth/200),_=2*(innerHeight/200),L,y,I=new Yt,R=[-100,-100];window.camera=I;b.width=innerWidth*devicePixelRatio;b.height=innerHeight*devicePixelRatio;let k=innerWidth/v,q=innerHeight/_;I.setPixelToTileRatio(k,q);let e=b.getContext("webgl");window.addEventListener("resize",()=>{b.width=innerWidth*devicePixelRatio,b.height=innerHeight*devicePixelRatio,e.viewport(0,0,b.width,b.height),v=2*(innerWidth/200),_=2*(innerHeight/200);let t=innerWidth/v,i=innerHeight/_;I.setPixelToTileRatio(t,i)});b.addEventListener("mousemove",t=>{const i=t.clientX/k/2,o=t.clientY/q/2*1.425,l=[i,o];N(l,l,[0,0],45*Math.PI/180);const r=[I.x/2+3.62,I.z/2-2.62];xt(l,l,r),Ft(l,l),R=l});b.addEventListener("click",t=>{const i=R[1]*y+R[0];C.setTile(R[0],R[1],L[i]+1)});Ht();async function Ht(){const t=A(new Gt);t.log();const i=A(new gt);i.log();const o=A(new zt);o.log(),await new t,C=await new i,await C.setCallback(O(f=>{L=f,y=Math.sqrt(L.length)})),H=await new o,await H.setCallback(O(f=>{Ot(f)}));const r=new URLSearchParams(location.search).get("save");r||(alert("Save not provided."),location.replace("../"));const a=await C.loadSave(r);a||(alert("Save couldn't be loaded."),location.replace("../")),document.title=`\u{1F3E0} ${r} \u2022 TapTown!`,console.log(a);const m=e.createShader(e.VERTEX_SHADER);e.shaderSource(m,It),e.compileShader(m);const n=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(n,pt),e.compileShader(n),!e.getShaderParameter(m,e.COMPILE_STATUS))return alert("An error occurred compiling the vert shaders: "+e.getShaderInfoLog(m)),e.deleteShader(m),null;if(!e.getShaderParameter(n,e.COMPILE_STATUS))return alert("An error occurred compiling the frag shaders: "+e.getShaderInfoLog(n)),e.deleteShader(n),null;const s=e.createProgram();if(e.attachShader(s,m),e.attachShader(s,n),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS))return alert("Unable to initialize the shader program: "+e.getProgramInfoLog(s)),null;const h={program:s,attribLocations:{vertexPosition:e.getAttribLocation(s,"aVertexPosition"),textureCoordPosition:e.getAttribLocation(s,"aTextureCoord")},uniformLocations:{projectionMatrix:e.getUniformLocation(s,"uProjectionMatrix"),modelViewMatrix:e.getUniformLocation(s,"uModelViewMatrix"),texture:e.getUniformLocation(s,"uTexture"),highlight:e.getUniformLocation(s,"uHighlight")}};await Jt(e);const u=f=>{kt(h),requestAnimationFrame(u)};requestAnimationFrame(u)}function kt(t){e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const i=e.canvas.clientHeight/e.canvas.clientWidth,o=.1,l=100,r=M();bt(r,0,v,0,v*i,o,l);const a=Math.floor(I.x/2)-1,m=Math.floor(I.z/2)-5;for(let n=m;n<m+_*2;n++){let s=n*y;for(let h=a;h<a+v*2;h++){let u=s+h;h===R[0]&&n===R[1]?e.uniform1i(t.uniformLocations.highlight,1):e.uniform1i(t.uniformLocations.highlight,0),!(h>=y)&&!(h<0)&&!(n<0)&&!(n>=y)?z(e,L[u],[h,n],t,r,I.cameraMatrix):z(e,254,[h,n],t,r,I.cameraMatrix)}}}

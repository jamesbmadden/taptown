var dt=Object.defineProperty;var ft=(t,r,o)=>r in t?dt(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o;var w=(t,r,o)=>(ft(t,typeof r!="symbol"?r+"":r,o),o);import{d as ut,g as ht}from"./db.ffa5ff42.js";import{c as b,s as W,f as lt,m as mt,t as _,a as xt,r as X,b as B,d as V,e as wt,g as pt,w as D,p as g,o as Tt}from"./vendor.9b089b60.js";var vt=`attribute vec4 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat4 uModelViewMatrix;
uniform mat4 uProjectionMatrix;

varying highp vec2 vTextureCoord;

void main(void) {
  gl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;
  vTextureCoord = aTextureCoord;
}`,_t=`varying highp vec2 vTextureCoord;
uniform sampler2D uTexture;

void main(void) {

  gl_FragColor = texture2D(uTexture, vTextureCoord);
  
}`;function Rt(t,r){return new Promise((o,c)=>{const i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i);const e=new Image;e.onload=()=>{t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),N(e.width)&&N(e.height)?t.generateMipmap(t.TEXTURE_2D):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),o(i)},e.src=r})}function N(t){return(t&t-1)==0}function u(t,r){return new Promise(async(o,c)=>{const e=await(await fetch(r)).json(),l=e.scenes[e.scene],n=await(await fetch(e.buffers[0].uri)).blob();let s=[...l.nodes],h=0,m=[],x=[],M=[];for(;h<s.length;){let Q=x.length/3;const p=e.nodes[s[h]];if(p.children&&s.push(...p.children),p.mesh!==void 0){let R=b();if(p.scale&&W(R,R,p.scale),p.rotation){const T=b();lt(T,p.rotation),mt(R,R,T)}p.translation&&_(R,R,p.translation);const L=e.meshes[p.mesh].primitives[0],J=L.indices,K=e.accessors[J],F=e.bufferViews[K.bufferView],tt=n.slice(F.byteOffset,F.byteOffset+F.byteLength),et=new Int16Array(await tt.arrayBuffer());m.push(...et.map(T=>T+Q));const at=L.attributes.POSITION,rt=e.accessors[at],C=e.bufferViews[rt.bufferView],ot=n.slice(C.byteOffset,C.byteOffset+C.byteLength),P=new Float32Array(await ot.arrayBuffer());for(let T=0;T<P.length;T+=3){let U=[P[T],P[T+1],P[T+2]];xt(U,U,R),x.push(...U)}const it=L.attributes.TEXCOORD_0,st=e.accessors[it],S=e.bufferViews[st.bufferView],nt=n.slice(S.byteOffset,S.byteOffset+S.byteLength),ct=new Float32Array(await nt.arrayBuffer());M.push(...ct)}h++}const q=await Rt(t,e.images[0].uri),I=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,I),t.bufferData(t.ARRAY_BUFFER,new Float32Array(x),t.STATIC_DRAW);const Y=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,Y),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(m),t.STATIC_DRAW);const O=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,O),t.bufferData(t.ARRAY_BUFFER,new Float32Array(M),t.STATIC_DRAW),o({buffers:{index:Y,vertex:I,texCoords:O},indexCount:m.length,texture:q})})}var bt="/taptown/assets/Road-x.25087994.gltf",Mt="/taptown/assets/Road-right.05535041.gltf",Et="/taptown/assets/Road-left.e4d57c46.gltf",At="/taptown/assets/Road-y.43b84893.gltf",Pt="/taptown/assets/Road-up.f33fbfbe.gltf",yt="/taptown/assets/Road-down.3aa34828.gltf",Lt="/taptown/assets/Road-cross.c0149426.gltf",Ft="/taptown/assets/Road-upleft.8e8e8992.gltf",Ct="/taptown/assets/Road-leftdown.43e4587d.gltf",St="/taptown/assets/Road-downright.2ee19715.gltf",Ut="/taptown/assets/Road-rightup.f9b3a2d6.gltf",Xt="/taptown/assets/Road-T.dd27be2f.gltf",Bt="/taptown/assets/Road-l-.8fa437e2.gltf",Dt="/taptown/assets/Road--l.cec3388c.gltf",It="/taptown/assets/Road-_l_.04dac8e2.gltf",Yt="/taptown/assets/Road-single.f2299542.gltf",Ot="/taptown/assets/outofbounds.54610d6d.gltf",Wt="/taptown/assets/Cafe.89231c7b.gltf";const f=[null];let j=!1;async function Vt(t){f[1]=await u(t,bt),f[2]=await u(t,Mt),f[3]=await u(t,Et),f[4]=await u(t,At),f[5]=await u(t,Pt),f[6]=await u(t,yt),f[7]=await u(t,Lt),f[8]=await u(t,Ft),f[9]=await u(t,Ct),f[10]=await u(t,St),f[11]=await u(t,Ut),f[12]=await u(t,Xt),f[13]=await u(t,Bt),f[14]=await u(t,Dt),f[15]=await u(t,It),f[16]=await u(t,Yt),f[254]=await u(t,Ot),f[255]=await u(t,Wt),j=!0}function z(t,r,[o,c],i,e,l){if(!j)throw"Models aren't loaded!";const d=f[r];if(!d)return;const n=b();_(n,l,[o*2,0,c*2]);{const s=3,h=t.FLOAT,m=!1,x=0,M=0;t.bindBuffer(t.ARRAY_BUFFER,d.buffers.vertex),t.vertexAttribPointer(i.attribLocations.vertexPosition,s,h,m,x,M),t.enableVertexAttribArray(i.attribLocations.vertexPosition)}{const s=2,h=t.FLOAT,m=!1,x=0,M=0;t.bindBuffer(t.ARRAY_BUFFER,d.buffers.texCoords),t.vertexAttribPointer(i.attribLocations.textureCoordPosition,s,h,m,x,M),t.enableVertexAttribArray(i.attribLocations.textureCoordPosition)}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,d.buffers.index),t.useProgram(i.program),t.uniformMatrix4fv(i.uniformLocations.projectionMatrix,!1,e),t.uniformMatrix4fv(i.uniformLocations.modelViewMatrix,!1,n),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,d.texture),t.uniform1i(i.uniformLocations.texture,0),t.drawElements(t.TRIANGLES,d.indexCount,t.UNSIGNED_SHORT,0)}class gt{constructor(){w(this,"x",0);w(this,"z",0);w(this,"_pointerDown",!1);w(this,"_velocityX",0);w(this,"_velocityY",0);w(this,"_pixelToTileX");w(this,"_pixelToTileZ");w(this,"_prevPointerX");w(this,"_prevPointerY");w(this,"_inFocusMode",!1);w(this,"cameraMatrix",b());_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),X(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),B(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),document.addEventListener("pointerdown",r=>{this._pointerDown=!0,this._prevPointerX=r.clientX,this._prevPointerY=r.clientY}),document.addEventListener("pointerup",()=>this._pointerDown=!1),document.addEventListener("pointermove",r=>{this._pointerDown&&(this._moveCamera(r.clientX-this._prevPointerX,r.clientY-this._prevPointerY),this._velocityX=r.clientX-this._prevPointerX,this._velocityY=r.clientY-this._prevPointerY),this._prevPointerX=r.clientX,this._prevPointerY=r.clientY})}_moveCamera(r,o){if(this._inFocusMode)return;const c=r/this._pixelToTileX,i=o/this._pixelToTileZ*1.425,e=[c,i];V(e,e,[0,0],45*Math.PI/180),this.x-=e[0],this.z-=e[1],_(this.cameraMatrix,this.cameraMatrix,[e[0],0,e[1]])}setPixelToTileRatio(r,o){this._pixelToTileX=r,this._pixelToTileZ=o}update(r){let o=r/16.66667;this._pointerDown||(this._velocityX=Math.floor(Math.abs(this._velocityX)/10.25*o)*Math.sign(this._velocityX)*10*o,this._velocityY=Math.floor(Math.abs(this._velocityY)/10.25*o)*Math.sign(this._velocityY)*10*o,this._moveCamera(this._velocityX,this._velocityY))}enterFocus([r,o]){this._inFocusMode=!0;const c=Date.now(),i=()=>{let e=(Date.now()-c)/1e3;e>1&&(e=1);const l=45*(1-e)+15*e,d=-this.x*(1-e)+-r*2*e,n=-this.z*(1-e)+-r*2*e,s=1+e;this.cameraMatrix=b(),_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),X(this.cameraMatrix,this.cameraMatrix,l*Math.PI/180),B(this.cameraMatrix,this.cameraMatrix,l*Math.PI/180),W(this.cameraMatrix,this.cameraMatrix,[s,s,s]),_(this.cameraMatrix,this.cameraMatrix,[d,0,n]),e<1&&requestAnimationFrame(i)};requestAnimationFrame(i)}exitFocus(){this.cameraMatrix=b(),_(this.cameraMatrix,this.cameraMatrix,[0,1,-3]),X(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),B(this.cameraMatrix,this.cameraMatrix,45*Math.PI/180),_(this.cameraMatrix,this.cameraMatrix,[-this.x,0,-this.z]),this._inFocusMode=!1}}const Nt=document.querySelector(".money"),jt=document.querySelector(".population");function zt(t){Nt.textContent=`$${t.money}`,jt.textContent=`${t.population}`}function Ht(){return new Worker("/taptown/assets/ambient.6d469442.js",{type:"module"})}function kt(){return new Worker("/taptown/assets/buildings.8e47e127.js",{type:"module"})}function Gt(){return new Worker("/taptown/assets/people.9ab39b39.js",{type:"module"})}let H,k;const E=document.getElementsByTagName("canvas")[0];let A=2*(innerWidth/200),y=2*(innerHeight/200),G,v=new gt;window.camera=v;E.width=innerWidth;E.height=innerHeight;let Z=innerWidth/A,$=innerHeight/y;v.setPixelToTileRatio(Z,$);const a=E.getContext("webgl");window.addEventListener("resize",()=>{E.width=innerWidth,E.height=innerHeight,A=2*(innerWidth/200),y=2*(innerHeight/200);let t=innerWidth/A,r=innerHeight/y;v.setPixelToTileRatio(t,r)});E.addEventListener("click",t=>{const r=t.clientX/Z/2,o=t.clientY/$/2*1.425,c=[r,o];V(c,c,[0,0],45*Math.PI/180);const i=[v.x/2+3.62,v.z/2-2.62];wt(c,c,i),pt(c,c)});Zt();async function Zt(){const r=new URLSearchParams(location.search).get("save");r||(alert("Save not provided."),location.replace("../"));const o=await ut(),c=await ht(o,r);c||(alert("Save couldn't be loaded."),location.replace("../")),console.log(c);const i=D(new Ht);i.log();const e=D(new kt);e.log();const l=D(new Gt);l.log(),await new i,H=await new e,await H.setCallback(g(x=>{G=x})),k=await new l,await k.setCallback(g(x=>{zt(x)}));const d=a.createShader(a.VERTEX_SHADER);a.shaderSource(d,vt),a.compileShader(d);const n=a.createShader(a.FRAGMENT_SHADER);if(a.shaderSource(n,_t),a.compileShader(n),!a.getShaderParameter(d,a.COMPILE_STATUS))return alert("An error occurred compiling the vert shaders: "+a.getShaderInfoLog(d)),a.deleteShader(d),null;if(!a.getShaderParameter(n,a.COMPILE_STATUS))return alert("An error occurred compiling the frag shaders: "+a.getShaderInfoLog(n)),a.deleteShader(n),null;const s=a.createProgram();if(a.attachShader(s,d),a.attachShader(s,n),a.linkProgram(s),!a.getProgramParameter(s,a.LINK_STATUS))return alert("Unable to initialize the shader program: "+a.getProgramInfoLog(s)),null;const h={program:s,attribLocations:{vertexPosition:a.getAttribLocation(s,"aVertexPosition"),textureCoordPosition:a.getAttribLocation(s,"aTextureCoord")},uniformLocations:{projectionMatrix:a.getUniformLocation(s,"uProjectionMatrix"),modelViewMatrix:a.getUniformLocation(s,"uModelViewMatrix"),texture:a.getUniformLocation(s,"uTexture")}};await Vt(a);const m=x=>{$t(h),requestAnimationFrame(m)};requestAnimationFrame(m)}function $t(t){a.clearColor(0,0,0,1),a.clearDepth(1),a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);const r=a.canvas.clientHeight/a.canvas.clientWidth,o=.1,c=100,i=b();Tt(i,0,A,0,A*r,o,c);const e=20,l=Math.floor(v.x/2)-1,d=Math.floor(v.z/2)-5;for(let n=d;n<d+y*2;n++){let s=n*20;for(let h=l;h<l+A*2;h++){let m=s+h;!(h>=e)&&!(h<0)&&!(n<0)&&!(n>=e)?z(a,G[m],[h,n],t,i,v.cameraMatrix):z(a,254,[h,n],t,i,v.cameraMatrix)}}}
